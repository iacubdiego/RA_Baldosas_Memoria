'use client'

import { useState, useEffect } from 'react'
import ConvertirModal from '../../components/ConvertirModal'

interface Propuesta {
  id: string
  nombrePersona: string
  descripcion: string
  lat: number
  lng: number
  direccion?: string
  emailContacto?: string
  estado: 'pendiente' | 'aprobada' | 'rechazada'
  createdAt: string
  imagenBase64?: string
  notas?: string
}

export default function AdminPage() {
  const [propuestas, setPropuestas] = useState<Propuesta[]>([])
  const [loading, setLoading] = useState(true)
  const [filtroEstado, setFiltroEstado] = useState<string>('pendiente')
  const [propuestaSeleccionada, setPropuestaSeleccionada] = useState<Propuesta | null>(null)
  const [propuestaConvertir, setPropuestaConvertir] = useState<Propuesta | null>(null)
  const [procesando, setProcesando] = useState(false)
  const [mensaje, setMensaje] = useState<{ tipo: 'exito' | 'error'; texto: string } | null>(null)

  const cargarPropuestas = async () => {
    setLoading(true)
    try {
      const response = await fetch(`/api/propuestas?estado=${filtroEstado}`)
      const data = await response.json()
      setPropuestas(data.propuestas || [])
    } catch (error) {
      console.error('Error cargando propuestas:', error)
      setMensaje({ tipo: 'error', texto: 'Error al cargar propuestas' })
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    cargarPropuestas()
  }, [filtroEstado])

  const aprobarPropuesta = async (id: string) => {
    setProcesando(true)
    try {
      const response = await fetch(`/api/propuestas/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ estado: 'aprobada' }),
      })
      
      if (response.ok) {
        setMensaje({ tipo: 'exito', texto: '‚úÖ Propuesta aprobada. Ahora pod√©s convertirla a baldosa.' })
        setPropuestaSeleccionada(null)
        cargarPropuestas()
      } else {
        throw new Error('Error al aprobar')
      }
    } catch (error) {
      setMensaje({ tipo: 'error', texto: 'Error al aprobar la propuesta' })
    } finally {
      setProcesando(false)
    }
  }

  const rechazarPropuesta = async (id: string) => {
    setProcesando(true)
    try {
      const response = await fetch(`/api/propuestas/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ estado: 'rechazada' }),
      })
      
      if (response.ok) {
        setMensaje({ tipo: 'exito', texto: 'Propuesta rechazada' })
        setPropuestaSeleccionada(null)
        cargarPropuestas()
      } else {
        throw new Error('Error al rechazar')
      }
    } catch (error) {
      setMensaje({ tipo: 'error', texto: 'Error al rechazar la propuesta' })
    } finally {
      setProcesando(false)
    }
  }

  const verDetalle = async (propuesta: Propuesta) => {
    try {
      const response = await fetch(`/api/propuestas/${propuesta.id}`)
      const data = await response.json()
      setPropuestaSeleccionada(data.propuesta)
    } catch (error) {
      setPropuestaSeleccionada(propuesta)
    }
  }

  const formatearFecha = (fecha: string) => {
    return new Date(fecha).toLocaleDateString('es-AR', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
    })
  }

  const esProcesada = (propuesta: Propuesta) => {
    return propuesta.notas?.includes('Procesada ‚Üí')
  }

  return (
    <div style={{
      minHeight: '100vh',
      background: '#f0f4f8',
      padding: '20px',
    }}>
      <div style={{ maxWidth: '1200px', margin: '0 auto' }}>
        
        {/* Header */}
        <div style={{
          background: '#1a2a3a',
          color: 'white',
          padding: '20px 30px',
          borderRadius: '12px',
          marginBottom: '20px',
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          flexWrap: 'wrap',
          gap: '15px',
        }}>
          <div>
            <h1 style={{ fontSize: '1.5rem', marginBottom: '5px' }}>
              Panel de Administraci√≥n
            </h1>
            <p style={{ opacity: 0.7, fontSize: '0.9rem' }}>
              Gesti√≥n de propuestas y creaci√≥n de baldosas
            </p>
          </div>
          <a 
            href="/"
            style={{
              color: 'white',
              textDecoration: 'none',
              padding: '8px 16px',
              background: 'rgba(255,255,255,0.1)',
              borderRadius: '6px',
              fontSize: '0.9rem',
            }}
          >
            ‚Üê Volver al sitio
          </a>
        </div>

        {/* Mensaje */}
        {mensaje && (
          <div style={{
            padding: '15px 20px',
            borderRadius: '8px',
            marginBottom: '20px',
            background: mensaje.tipo === 'exito' ? '#dcfce7' : '#fef2f2',
            color: mensaje.tipo === 'exito' ? '#166534' : '#dc2626',
            border: `1px solid ${mensaje.tipo === 'exito' ? '#22c55e' : '#ef4444'}`,
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
          }}>
            <span>{mensaje.texto}</span>
            <button 
              onClick={() => setMensaje(null)}
              style={{
                background: 'none',
                border: 'none',
                fontSize: '1.2rem',
                cursor: 'pointer',
                opacity: 0.5,
              }}
            >
              ‚úï
            </button>
          </div>
        )}

        {/* Filtros */}
        <div style={{
          background: 'white',
          padding: '15px 20px',
          borderRadius: '8px',
          marginBottom: '20px',
          display: 'flex',
          gap: '10px',
          flexWrap: 'wrap',
          alignItems: 'center',
        }}>
          <span style={{ fontWeight: 500, color: '#4a6b7c' }}>Filtrar por estado:</span>
          {['pendiente', 'aprobada', 'rechazada'].map((estado) => (
            <button
              key={estado}
              onClick={() => setFiltroEstado(estado)}
              style={{
                padding: '8px 16px',
                borderRadius: '20px',
                border: 'none',
                cursor: 'pointer',
                fontWeight: 500,
                fontSize: '0.9rem',
                background: filtroEstado === estado ? '#2563eb' : '#e5e7eb',
                color: filtroEstado === estado ? 'white' : '#4a6b7c',
                transition: 'all 0.2s',
              }}
            >
              {estado.charAt(0).toUpperCase() + estado.slice(1)}
            </button>
          ))}
          <span style={{ 
            marginLeft: 'auto', 
            color: '#4a6b7c',
            fontSize: '0.9rem',
          }}>
            {propuestas.length} propuesta{propuestas.length !== 1 ? 's' : ''}
          </span>
        </div>

        {/* Lista de propuestas */}
        {loading ? (
          <div style={{
            background: 'white',
            padding: '60px',
            borderRadius: '8px',
            textAlign: 'center',
          }}>
            <div style={{
              width: '40px',
              height: '40px',
              margin: '0 auto 15px',
              border: '4px solid #e5e7eb',
              borderTopColor: '#2563eb',
              borderRadius: '50%',
              animation: 'spin 1s linear infinite',
            }} />
            <p style={{ color: '#4a6b7c' }}>Cargando propuestas...</p>
          </div>
        ) : propuestas.length === 0 ? (
          <div style={{
            background: 'white',
            padding: '60px',
            borderRadius: '8px',
            textAlign: 'center',
          }}>
            <p style={{ color: '#4a6b7c', fontSize: '1.1rem' }}>
              No hay propuestas {filtroEstado === 'pendiente' ? 'pendientes' : filtroEstado + 's'}
            </p>
          </div>
        ) : (
          <div style={{
            display: 'grid',
            gap: '15px',
          }}>
            {propuestas.map((propuesta) => {
              const procesada = esProcesada(propuesta)
              
              return (
                <div
                  key={propuesta.id}
                  style={{
                    background: 'white',
                    padding: '20px',
                    borderRadius: '8px',
                    boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'flex-start',
                    gap: '20px',
                    flexWrap: 'wrap',
                    opacity: procesada ? 0.6 : 1,
                  }}
                >
                  <div style={{ flex: 1, minWidth: '250px' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '8px' }}>
                      <h3 style={{ 
                        fontSize: '1.1rem', 
                        color: '#1a2a3a',
                        margin: 0,
                      }}>
                        {propuesta.nombrePersona}
                      </h3>
                      {procesada && (
                        <span style={{
                          padding: '2px 8px',
                          background: '#22c55e',
                          color: 'white',
                          borderRadius: '12px',
                          fontSize: '0.75rem',
                          fontWeight: 500,
                        }}>
                          ‚úì Procesada
                        </span>
                      )}
                    </div>
                    <p style={{
                      fontSize: '0.8rem',
                      color: '#2563eb',
                      textTransform: 'uppercase',
                      letterSpacing: '0.05em',
                      marginBottom: '8px',
                    }}>
                      {propuesta.estado}
                    </p>
                    <p style={{ 
                      color: '#4a6b7c', 
                      fontSize: '0.95rem',
                      marginBottom: '10px',
                      display: '-webkit-box',
                      WebkitLineClamp: 2,
                      WebkitBoxOrient: 'vertical',
                      overflow: 'hidden',
                    }}>
                      {propuesta.descripcion}
                    </p>
                    <div style={{ 
                      display: 'flex', 
                      gap: '15px', 
                      fontSize: '0.85rem',
                      color: '#6b7280',
                      flexWrap: 'wrap',
                    }}>
                      <span>üìç {propuesta.lat.toFixed(4)}, {propuesta.lng.toFixed(4)}</span>
                      <span>üìÖ {formatearFecha(propuesta.createdAt)}</span>
                      {propuesta.emailContacto && (
                        <span>üìß {propuesta.emailContacto}</span>
                      )}
                    </div>
                    {procesada && propuesta.notas && (
                      <p style={{
                        marginTop: '10px',
                        fontSize: '0.8rem',
                        color: '#16a34a',
                        padding: '6px 10px',
                        background: '#f0fdf4',
                        borderRadius: '4px',
                      }}>
                        {propuesta.notas}
                      </p>
                    )}
                  </div>
                  
                  <div style={{ 
                    display: 'flex', 
                    gap: '10px',
                    flexShrink: 0,
                    flexWrap: 'wrap',
                  }}>
                    <button
                      onClick={() => verDetalle(propuesta)}
                      style={{
                        padding: '8px 16px',
                        background: '#f3f4f6',
                        border: 'none',
                        borderRadius: '6px',
                        cursor: 'pointer',
                        fontWeight: 500,
                        color: '#4a6b7c',
                        fontSize: '0.9rem',
                      }}
                    >
                      Ver detalle
                    </button>
                    {filtroEstado === 'pendiente' && (
                      <>
                        <button
                          onClick={() => aprobarPropuesta(propuesta.id)}
                          disabled={procesando}
                          style={{
                            padding: '8px 16px',
                            background: '#22c55e',
                            border: 'none',
                            borderRadius: '6px',
                            cursor: 'pointer',
                            fontWeight: 500,
                            color: 'white',
                            fontSize: '0.9rem',
                          }}
                        >
                          Aprobar
                        </button>
                        <button
                          onClick={() => rechazarPropuesta(propuesta.id)}
                          disabled={procesando}
                          style={{
                            padding: '8px 16px',
                            background: '#ef4444',
                            border: 'none',
                            borderRadius: '6px',
                            cursor: 'pointer',
                            fontWeight: 500,
                            color: 'white',
                            fontSize: '0.9rem',
                          }}
                        >
                          Rechazar
                        </button>
                      </>
                    )}
                    {filtroEstado === 'aprobada' && !procesada && (
                      <button
                        onClick={() => setPropuestaConvertir(propuesta)}
                        style={{
                          padding: '8px 16px',
                          background: '#2563eb',
                          border: 'none',
                          borderRadius: '6px',
                          cursor: 'pointer',
                          fontWeight: 500,
                          color: 'white',
                          fontSize: '0.9rem',
                          display: 'flex',
                          alignItems: 'center',
                          gap: '6px',
                        }}
                      >
                        <span>‚Üí</span> Convertir a Baldosa
                      </button>
                    )}
                  </div>
                </div>
              )
            })}
          </div>
        )}

        {/* Modal de detalle */}
        {propuestaSeleccionada && (
          <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0,0,0,0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            padding: '20px',
            zIndex: 1000,
          }} onClick={() => setPropuestaSeleccionada(null)}>
            <div style={{
              background: 'white',
              borderRadius: '12px',
              maxWidth: '600px',
              width: '100%',
              maxHeight: '90vh',
              overflow: 'auto',
            }} onClick={(e) => e.stopPropagation()}>
              <div style={{
                padding: '20px',
                borderBottom: '1px solid #e5e7eb',
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
              }}>
                <h2 style={{ fontSize: '1.2rem', color: '#1a2a3a' }}>
                  Detalle de Propuesta
                </h2>
                <button
                  onClick={() => setPropuestaSeleccionada(null)}
                  style={{
                    background: 'none',
                    border: 'none',
                    fontSize: '1.5rem',
                    cursor: 'pointer',
                    color: '#6b7280',
                  }}
                >
                  ‚úï
                </button>
              </div>
              
              <div style={{ padding: '20px' }}>
                <div style={{ marginBottom: '20px' }}>
                  <label style={{ 
                    fontSize: '0.85rem', 
                    color: '#6b7280',
                    display: 'block',
                    marginBottom: '5px',
                  }}>
                    Persona homenajeada
                  </label>
                  <p style={{ 
                    fontSize: '1.2rem', 
                    fontWeight: 600,
                    color: '#1a2a3a',
                  }}>
                    {propuestaSeleccionada.nombrePersona}
                  </p>
                </div>

                <div style={{ marginBottom: '20px' }}>
                  <label style={{ 
                    fontSize: '0.85rem', 
                    color: '#6b7280',
                    display: 'block',
                    marginBottom: '5px',
                  }}>
                    Descripci√≥n
                  </label>
                  <p style={{ 
                    color: '#4a6b7c',
                    lineHeight: 1.6,
                  }}>
                    {propuestaSeleccionada.descripcion}
                  </p>
                </div>

                <div style={{ 
                  display: 'grid', 
                  gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                  gap: '15px',
                  marginBottom: '20px',
                }}>
                  <div>
                    <label style={{ 
                      fontSize: '0.85rem', 
                      color: '#6b7280',
                      display: 'block',
                      marginBottom: '5px',
                    }}>
                      Ubicaci√≥n
                    </label>
                    <p style={{ color: '#1a2a3a', marginBottom: '5px' }}>
                      {propuestaSeleccionada.lat.toFixed(6)}, {propuestaSeleccionada.lng.toFixed(6)}
                    </p>
                    <a
                      href={`https://www.google.com/maps?q=${propuestaSeleccionada.lat},${propuestaSeleccionada.lng}`}
                      target="_blank"
                      rel="noopener noreferrer"
                      style={{
                        color: '#2563eb',
                        fontSize: '0.85rem',
                      }}
                    >
                      Ver en Google Maps ‚Üó
                    </a>
                  </div>

                  {propuestaSeleccionada.direccion && (
                    <div>
                      <label style={{ 
                        fontSize: '0.85rem', 
                        color: '#6b7280',
                        display: 'block',
                        marginBottom: '5px',
                      }}>
                        Direcci√≥n
                      </label>
                      <p style={{ color: '#1a2a3a' }}>
                        {propuestaSeleccionada.direccion}
                      </p>
                    </div>
                  )}
                </div>

                {propuestaSeleccionada.imagenBase64 && (
                  <div style={{ marginBottom: '20px' }}>
                    <label style={{ 
                      fontSize: '0.85rem', 
                      color: '#6b7280',
                      display: 'block',
                      marginBottom: '10px',
                    }}>
                      Imagen adjunta
                    </label>
                    <img
                      src={propuestaSeleccionada.imagenBase64}
                      alt="Imagen de la baldosa"
                      style={{
                        width: '100%',
                        maxHeight: '300px',
                        objectFit: 'cover',
                        borderRadius: '8px',
                      }}
                    />
                  </div>
                )}

                {propuestaSeleccionada.estado === 'pendiente' && (
                  <div style={{
                    display: 'flex',
                    gap: '10px',
                    paddingTop: '15px',
                    borderTop: '1px solid #e5e7eb',
                  }}>
                    <button
                      onClick={() => aprobarPropuesta(propuestaSeleccionada.id)}
                      disabled={procesando}
                      style={{
                        flex: 1,
                        padding: '12px',
                        background: '#22c55e',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        fontWeight: 600,
                        color: 'white',
                        fontSize: '1rem',
                      }}
                    >
                      {procesando ? 'Procesando...' : '‚úì Aprobar'}
                    </button>
                    <button
                      onClick={() => rechazarPropuesta(propuestaSeleccionada.id)}
                      disabled={procesando}
                      style={{
                        flex: 1,
                        padding: '12px',
                        background: '#ef4444',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        fontWeight: 600,
                        color: 'white',
                        fontSize: '1rem',
                      }}
                    >
                      {procesando ? 'Procesando...' : '‚úï Rechazar'}
                    </button>
                  </div>
                )}
              </div>
            </div>
          </div>
        )}

        {/* Modal de conversi√≥n */}
        {propuestaConvertir && (
          <ConvertirModal
            propuesta={propuestaConvertir}
            onClose={() => setPropuestaConvertir(null)}
            onSuccess={() => {
              setMensaje({ 
                tipo: 'exito', 
                texto: 'üéâ ¬°Baldosa creada exitosamente! Ya est√° disponible para escanear.' 
              })
              cargarPropuestas()
            }}
          />
        )}
      </div>

      <style jsx>{`
        @keyframes spin {
          to { transform: rotate(360deg); }
        }
      `}</style>
    </div>
  )
}
