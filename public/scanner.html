<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="UTF-8">
    <title>Escanear Baldosa - Baldosas por la Memoria</title>
    
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        overflow: hidden;
        background: #1a2a3a;
      }
      
      #loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #1a2a3a;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        color: white;
      }
      
      #loading .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255,255,255,0.2);
        border-top-color: #2563eb;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      
      #loading p {
        font-size: 16px;
        opacity: 0.9;
        text-align: center;
        padding: 0 20px;
      }
      
      #loading .hint {
        font-size: 13px;
        opacity: 0.6;
        margin-top: 10px;
      }
      
      #loading .status {
        margin-top: 20px;
        padding: 10px 20px;
        background: rgba(255,255,255,0.1);
        border-radius: 8px;
        font-size: 14px;
      }
      
      #permission-request {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #1a2a3a;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        color: white;
        padding: 30px;
        text-align: center;
      }
      
      #permission-request .icon {
        font-size: 72px;
        margin-bottom: 25px;
        animation: pulse 2s ease-in-out infinite;
      }
      
      @keyframes pulse {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.8; }
      }
      
      #permission-request h2 {
        font-size: 1.8rem;
        margin-bottom: 15px;
        font-weight: 600;
      }
      
      #permission-request p {
        font-size: 1rem;
        opacity: 0.85;
        line-height: 1.6;
        margin-bottom: 12px;
        max-width: 400px;
      }
      
      #permission-request .why {
        font-size: 0.9rem;
        opacity: 0.7;
        margin-top: 20px;
      }
      
      #permission-request button {
        margin-top: 25px;
        padding: 15px 35px;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
      }
      
      #permission-request button:hover {
        background: #1d4ed8;
      }
      
      #permission-request .skip-btn {
        background: transparent;
        border: 2px solid rgba(255,255,255,0.3);
        margin-top: 10px;
      }
      
      #permission-request .skip-btn:hover {
        background: rgba(255,255,255,0.1);
        border-color: rgba(255,255,255,0.5);
      }
      
      #permission-denied {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #1a2a3a;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        color: white;
        padding: 30px;
        text-align: center;
      }
      
      #permission-denied .icon {
        font-size: 72px;
        margin-bottom: 20px;
      }
      
      #permission-denied h2 {
        font-size: 1.6rem;
        margin-bottom: 15px;
      }
      
      #permission-denied p {
        font-size: 1rem;
        opacity: 0.85;
        line-height: 1.6;
        margin-bottom: 15px;
        max-width: 400px;
      }
      
      #permission-denied .instructions {
        background: rgba(255,255,255,0.1);
        padding: 20px;
        border-radius: 12px;
        margin: 25px 0;
        max-width: 400px;
      }
      
      #permission-denied .instructions h3 {
        font-size: 1.1rem;
        margin-bottom: 15px;
        color: #0ea5e9;
      }
      
      #permission-denied .instructions ol {
        text-align: left;
        line-height: 1.8;
        padding-left: 20px;
      }
      
      #permission-denied button {
        padding: 12px 30px;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
      }
      
      #permission-denied button:hover {
        background: #1d4ed8;
      }
      
      #no-baldosa {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #1a2a3a;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        color: white;
        padding: 30px;
        text-align: center;
      }
      
      #no-baldosa .icon {
        font-size: 72px;
        margin-bottom: 20px;
      }
      
      #no-baldosa h2 {
        font-size: 1.6rem;
        margin-bottom: 15px;
      }
      
      #no-baldosa p {
        font-size: 1rem;
        opacity: 0.85;
        line-height: 1.6;
        margin-bottom: 25px;
        max-width: 400px;
      }
      
      #no-baldosa button {
        padding: 12px 30px;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
      }
      
      #no-baldosa button:hover {
        background: #1d4ed8;
      }
      
      #no-baldosa .distance {
        font-size: 2.5rem;
        font-weight: 700;
        color: #0ea5e9;
        margin: 10px 0;
      }
      
      #no-baldosa .baldosa-name {
        font-size: 1.1rem;
        opacity: 0.8;
      }
      
      #btn-volver {
        position: fixed;
        top: 15px;
        left: 15px;
        background: rgba(26, 42, 58, 0.9);
        color: white;
        padding: 10px 18px;
        border-radius: 8px;
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        z-index: 1001;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.1);
        transition: background 0.2s;
      }
      
      #btn-volver:hover {
        background: rgba(26, 42, 58, 1);
      }
      
      #btn-mapa {
        position: fixed;
        top: 15px;
        right: 15px;
        background: rgba(37, 99, 235, 0.9);
        color: white;
        padding: 10px 18px;
        border-radius: 8px;
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        z-index: 1001;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.1);
        display: none;
        align-items: center;
        gap: 8px;
        transition: background 0.2s;
      }
      
      #btn-mapa:hover {
        background: rgba(37, 99, 235, 1);
      }
      
      .toast {
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: #2563eb;
        color: white;
        padding: 12px 24px;
        border-radius: 25px;
        font-size: 14px;
        z-index: 9999;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        animation: fadeInUp 0.3s ease-out;
      }
      
      .toast.error {
        background: #dc2626;
      }
      
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateX(-50%) translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateX(-50%) translateY(0);
        }
      }
      
      #instructions {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(26, 42, 58, 0.95);
        color: white;
        padding: 30px;
        border-radius: 16px;
        text-align: center;
        z-index: 1000;
        max-width: 90%;
        width: 380px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.1);
        box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        transition: opacity 0.5s ease-out;
        display: none;
      }
      
      #instructions .icon {
        font-size: 48px;
        margin-bottom: 15px;
      }
      
      #instructions h2 {
        font-size: 1.4rem;
        margin-bottom: 10px;
        font-weight: 600;
      }
      
      #instructions p {
        font-size: 0.95rem;
        opacity: 0.85;
        line-height: 1.5;
        margin-bottom: 15px;
      }
      
      #instructions .baldosa-info {
        background: rgba(37, 99, 235, 0.2);
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
      }
      
      #instructions .baldosa-info .name {
        font-weight: 600;
        font-size: 1.1rem;
        color: #0ea5e9;
      }
      
      #instructions .baldosa-info .address {
        font-size: 0.85rem;
        opacity: 0.7;
        margin-top: 5px;
      }
      
      #info-panel {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        color: white;
        padding: 0;
        z-index: 1000;
        display: none;
        animation: slideUp 0.3s ease-out;
        overflow: hidden;
      }
      
      @keyframes slideUp {
        from {
          transform: translateY(100%);
        }
        to {
          transform: translateY(0);
        }
      }
      
      #info-panel .baldosa-bg {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: url('/baldoson.jpg');
        background-size: cover;
        background-position: center;
        filter: brightness(0.3);
        z-index: 0;
      }
      
      #info-panel .content {
        position: relative;
        z-index: 1;
        padding: 15px 18px;
        display: flex;
        align-items: flex-start;
        gap: 10px;
        max-width: 480px;
        margin: 0 auto;
      }
      
      #info-panel .checkmark {
        width: 36px;
        height: 36px;
        background: #2563eb;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        flex-shrink: 0;
      }
      
      #info-panel .info-text {
        flex: 1;
      }
      
      #info-panel h3 {
        font-size: 1.1rem;
        margin-bottom: 3px;
        text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        line-height: 1.2;
      }
      
      #info-panel .categoria {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #0ea5e9;
        margin-bottom: 6px;
      }
      
      #info-panel .descripcion {
        display: none; /* Ocultar descripci√≥n para panel compacto */
      }
      
      #info-panel .btn-mas-info {
        margin-top: 8px;
        padding: 7px 14px;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        transition: all 0.3s;
        width: 100%;
        justify-content: center;
      }
      
      #info-panel .btn-mas-info:hover {
        background: #1d4ed8;
        transform: scale(1.02);
      }
      
      /* NUEVO: Bot√≥n guardar en colecci√≥n */
      #info-panel .btn-guardar-coleccion {
        margin-top: 6px;
        padding: 7px 14px;
        background: #10b981;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        width: 100%;
        justify-content: center;
        transition: all 0.3s;
      }
      
      #info-panel .btn-guardar-coleccion:hover {
        background: #059669;
        transform: scale(1.02);
      }
      
      #info-panel .btn-guardar-coleccion:active {
        transform: scale(0.98);
      }
      
      #memorial-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 100;
        display: none;
        pointer-events: none;
      }
      
      #siluetas-container {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        top: 0;
        overflow: hidden;
        pointer-events: none;
        z-index: 100;
      }
      
      .silueta {
        position: absolute;
        width: 50px;
        height: auto;
        opacity: 0;
        animation: aparecerSilueta 0.8s ease-out forwards;
      }
      
      .silueta img {
        width: 100%;
        height: auto;
        opacity: 0.25;
        filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
      }
      
      @keyframes aparecerSilueta {
        0% {
          opacity: 0;
          transform: scale(0.5);
        }
        100% {
          opacity: 1;
          transform: scale(1);
        }
      }
      
      #memorial-gif {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: 200px;
        height: auto;
        z-index: 101;
        opacity: 0;
        animation: aparecer 1s ease-out 1.5s forwards;
      }
      
      @keyframes aparecer {
        to {
          opacity: 1;
        }
      }
      
      #cerrar-memorial {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(220, 38, 38, 0.9);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        z-index: 102;
        pointer-events: all;
        backdrop-filter: blur(10px);
        transition: background 0.2s;
      }
      
      #cerrar-memorial:hover {
        background: rgba(220, 38, 38, 1);
      }
      
      #ar-container {
        display: none;
        width: 100%;
        height: 100%;
      }
      
      /* NUEVO: Animaci√≥n slideDown para toast */
      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateX(-50%) translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(-50%) translateY(0);
        }
      }
      
      /* Bot√≥n flotante de captura */
      #btn-capturar {
        position: fixed;
        bottom: 40px;
        right: 20px;
        width: 70px;
        height: 70px;
        background: rgba(37, 99, 235, 0.95);
        border: 4px solid white;
        border-radius: 50%;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1001;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        transition: all 0.3s;
        animation: pulseCapture 2s ease-in-out infinite;
      }
      
      #btn-capturar:hover {
        transform: scale(1.1);
        background: rgba(29, 78, 216, 0.95);
      }
      
      #btn-capturar:active {
        transform: scale(0.95);
      }
      
      #btn-capturar .camera-icon {
        color: white;
        font-size: 28px;
      }
      
      @keyframes pulseCapture {
        0%, 100% {
          box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        50% {
          box-shadow: 0 4px 30px rgba(37, 99, 235, 0.8);
        }
      }
      
      /* Info adicional en panel */
      #info-panel .info-extra {
        display: flex;
        gap: 10px;
        margin-top: 6px;
        padding-top: 6px;
        border-top: 1px solid rgba(255,255,255,0.15);
        flex-wrap: wrap;
      }
      
      #info-panel .info-item {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 0.7rem;
        opacity: 0.85;
      }
      
      #info-panel .info-item-icon {
        font-size: 0.85rem;
      }
    </style>
  </head>

  <body>
    <div id="permission-request">
      <div class="icon">üìç</div>
      <h2>Necesitamos tu ubicaci√≥n</h2>
      <p>Para encontrar las baldosas de la memoria cercanas, necesitamos acceder a tu ubicaci√≥n.</p>
      <p class="why">Tu ubicaci√≥n solo se usa para mostrar baldosas cercanas y no se guarda ni comparte.</p>
      <button onclick="solicitarPermiso()">Permitir ubicaci√≥n</button>
      <button class="skip-btn" onclick="window.location.href='/mapa'">Ver mapa sin ubicaci√≥n</button>
    </div>
    
    <div id="permission-denied">
      <div class="icon">üö´</div>
      <h2>Ubicaci√≥n no disponible</h2>
      <p>No pudimos acceder a tu ubicaci√≥n. Para usar el esc√°ner, necesit√°s habilitar el permiso de ubicaci√≥n.</p>
      <div class="instructions">
        <h3>¬øC√≥mo habilitarlo?</h3>
        <ol>
          <li>Toc√° el √≠cono de candado üîí en la barra de direcciones</li>
          <li>Busc√° "Ubicaci√≥n" o "Location"</li>
          <li>Cambi√° a "Permitir"</li>
          <li>Recarg√° la p√°gina</li>
        </ol>
      </div>
      <button onclick="window.location.reload()">üîÑ Reintentar</button>
      <br>
      <a href="/mapa" style="display: inline-block; margin-top: 15px; color: #0ea5e9; text-decoration: none;">Ver mapa sin ubicaci√≥n ‚Üí</a>
    </div>
    
    <div id="loading" style="display: none;">
      <div class="spinner"></div>
      <p id="loading-text">Obteniendo tu ubicaci√≥n...</p>
      <p class="hint">Esto puede tardar unos segundos</p>
      <div class="status" id="loading-status"></div>
    </div>
    
    <div id="no-baldosa">
      <div class="icon">üìç</div>
      <h2>No hay baldosas cerca</h2>
      <p>Para escanear una baldosa, necesit√°s estar f√≠sicamente cerca de ella.</p>
      <div id="nearest-info" style="display: none;">
        <p>La baldosa m√°s cercana est√° a:</p>
        <div class="distance" id="nearest-distance">--</div>
        <div class="baldosa-name" id="nearest-name">--</div>
      </div>
      <div>
        <button onclick="reintentar()">üîÑ Actualizar ubicaci√≥n</button>
        <a href="/mapa" class="btn-secondary" style="display: inline-block; padding: 12px 30px; color: white; text-decoration: none; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; margin-left: 10px;">Ver mapa</a>
      </div>
    </div>
    
    <a href="/" id="btn-volver">
      ‚Üê Volver
    </a>
    
    <a href="/mapa" id="btn-mapa">
      üó∫Ô∏è Ver mapa
    </a>
    
    <!-- NUEVO: Bot√≥n flotante de captura -->
    <button id="btn-capturar" onclick="capturarYMostrarPreview()">
      <span class="camera-icon">üì∑</span>
    </button>
    
    <div id="instructions">
      <div class="icon">üì∑</div>
      <h2>Apunt√° tu c√°mara a la baldosa</h2>
      <p>Est√°s cerca de una baldosa de la memoria. Enfocala con tu c√°mara para ver su historia.</p>
      <div class="baldosa-info">
        <div class="name" id="instruction-baldosa-name">--</div>
        <div class="address" id="instruction-baldosa-address">--</div>
      </div>
    </div>
    
    <div id="info-panel">
      <div class="baldosa-bg"></div>
      <div class="content">
        <div class="checkmark">‚úì</div>
        <div class="info-text">
          <h3 id="info-nombre">Nombre</h3>
          <div class="categoria" id="info-categoria">Categor√≠a</div>
          <p class="descripcion" id="info-descripcion">Descripci√≥n</p>
          
          <!-- NUEVO: Info adicional -->
          <div class="info-extra">
            <div class="info-item">
              <span class="info-item-icon">üìç</span>
              <span id="info-ubicacion">--</span>
            </div>
            <div class="info-item">
              <span class="info-item-icon">üìÖ</span>
              <span id="info-fecha">--</span>
            </div>
          </div>
          
          <button class="btn-mas-info" onclick="mostrarMasInfo()">
            üìñ M√°s informaci√≥n
          </button>
          <!-- NUEVO: Bot√≥n guardar en colecci√≥n -->
          <button class="btn-guardar-coleccion" onclick="guardarEnColeccion()">
            üì∏ Guardar en mi colecci√≥n
          </button>
        </div>
      </div>
    </div>
    
    <div id="memorial-overlay">
      <div id="siluetas-container"></div>
      <img id="memorial-gif" src="/memorial.gif" alt="Memorial" onerror="this.style.display='none'">
      <button id="cerrar-memorial" onclick="cerrarMemorial()">‚úï Cerrar</button>
    </div>

    <div id="ar-container"></div>

    <script>
      // Configuraci√≥n
      const RADIO_MAXIMO = 1000; // metros
      
      let baldosaCercana = null;
      let currentBaldosa = null;
      let userLocation = null;
      let arScene = null;
      
      const loadingEl = document.getElementById('loading');
      const loadingText = document.getElementById('loading-text');
      const loadingStatus = document.getElementById('loading-status');
      const noBaldosaEl = document.getElementById('no-baldosa');
      const instructionsEl = document.getElementById('instructions');
      const infoPanelEl = document.getElementById('info-panel');
      const arContainer = document.getElementById('ar-container');
      const memorialOverlay = document.getElementById('memorial-overlay');
      const siluetasContainer = document.getElementById('siluetas-container');
      const permissionRequestEl = document.getElementById('permission-request');
      const permissionDeniedEl = document.getElementById('permission-denied');
      const btnCapturar = document.getElementById('btn-capturar');
      
      // =============== FUNCIONES DE COLECCI√ìN (NUEVO) ===============
      
      function obtenerFechaHoy() {
        const hoy = new Date();
        const opciones = { 
          weekday: 'long', 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        };
        return hoy.toLocaleDateString('es-AR', opciones);
      }
      
      async function capturarYMostrarPreview() {
        console.log('üì∏ Capturando desde bot√≥n flotante...');
        
        const foto = await capturarScreenshot();
        if (!foto) {
          mostrarToast('Error capturando foto', 'error');
          return;
        }
        
        // Guardar temporalmente
        window.ultimaFotoCapturada = foto;
        console.log('‚úÖ Foto guardada temporalmente, tama√±o:', Math.round(foto.length / 1024), 'KB');
        
        mostrarToast('¬°Foto capturada! üì∏', 'success');
      }
      
      function capturarScreenshot() {
        console.log('üì∏ Capturando screenshot...');
        
        return new Promise((resolve) => {
          // Esperar un frame para asegurar que el canvas est√° renderizado
          requestAnimationFrame(() => {
            try {
              const scene = document.querySelector('a-scene');
              if (!scene) {
                console.error('‚ùå No se encontr√≥ la escena A-Frame');
                resolve(null);
                return;
              }
              
              const canvas = scene.querySelector('canvas');
              if (!canvas) {
                console.error('‚ùå No se encontr√≥ el canvas');
                resolve(null);
                return;
              }
              
              // Capturar con calidad media para balance tama√±o/calidad
              const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
              
              // Verificar que el dataUrl es v√°lido
              if (!dataUrl || dataUrl.length < 100) {
                console.error('‚ùå Screenshot inv√°lido o vac√≠o');
                resolve(null);
                return;
              }
              
              const sizeKB = Math.round(dataUrl.length / 1024);
              console.log('‚úÖ Screenshot capturado exitosamente');
              console.log('üìè Tama√±o:', sizeKB, 'KB');
              console.log('üîç Preview:', dataUrl.substring(0, 50) + '...');
              
              resolve(dataUrl);
              
            } catch (error) {
              console.error('‚ùå Error capturando screenshot:', error);
              resolve(null);
            }
          });
        });
      }
      
      async function guardarEnColeccion() {
        if (!currentBaldosa) {
          mostrarToast('No hay baldosa detectada', 'error');
          return;
        }
        
        console.log('üíæ Guardando en colecci√≥n:', currentBaldosa.nombre);
        
        // Usar la √∫ltima foto capturada o capturar una nueva
        let foto = window.ultimaFotoCapturada;
        if (!foto) {
          console.log('üì∏ No hay foto capturada, capturando nueva...');
          foto = await capturarScreenshot();
        }
        
        if (!foto) {
          mostrarToast('Error capturando foto', 'error');
          return;
        }
        
        console.log('‚úÖ Foto lista para guardar, tama√±o:', Math.round(foto.length / 1024), 'KB');
        
        const coleccionStr = localStorage.getItem('baldosas_coleccion');
        let coleccion = { items: [], totalEscaneos: 0 };
        
        if (coleccionStr) {
          try {
            coleccion = JSON.parse(coleccionStr);
          } catch (e) {
            console.error('Error parseando colecci√≥n:', e);
          }
        }
        
        const yaExiste = coleccion.items.some(item => 
          item.baldosaId === (currentBaldosa.codigo || currentBaldosa.id)
        );
        
        if (yaExiste) {
          mostrarToast('Ya ten√©s esta baldosa en tu colecci√≥n', 'info');
          return;
        }
        
        const nuevoItem = {
          id: `item_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
          baldosaId: currentBaldosa.codigo || currentBaldosa.id,
          nombreVictima: currentBaldosa.nombre,
          fechaDesaparicion: currentBaldosa.fechaDesaparicion || '',
          fechaEscaneo: new Date().toISOString(),
          fotoUrl: foto,  // Base64 string
          ubicacion: currentBaldosa.direccion || currentBaldosa.barrio || 'Buenos Aires',
          lat: currentBaldosa.lat,
          lng: currentBaldosa.lng,
          notas: ''
        };
        
        console.log('üì¶ Nuevo item a guardar:', {
          ...nuevoItem,
          fotoUrl: nuevoItem.fotoUrl.substring(0, 50) + '...'
        });
        
        coleccion.items.unshift(nuevoItem);
        coleccion.totalEscaneos = coleccion.items.length;
        coleccion.ultimoEscaneo = nuevoItem.fechaEscaneo;
        
        localStorage.setItem('baldosas_coleccion', JSON.stringify(coleccion));
        
        console.log('‚úÖ Guardado en colecci√≥n!');
        console.log('üìä Total en colecci√≥n:', coleccion.totalEscaneos);
        
        // Limpiar foto temporal
        window.ultimaFotoCapturada = null;
        
        mostrarToast('¬°Guardado en tu colecci√≥n! üéâ', 'success');
        
        setTimeout(() => {
          window.location.href = '/coleccion';
        }, 1500);
      }
      
      // =============== FIN FUNCIONES DE COLECCI√ìN ===============
      
      function mostrarToast(mensaje, tipo = 'info', duracion = 3000) {
        const toastAnterior = document.querySelector('.toast');
        if (toastAnterior) {
          toastAnterior.remove();
        }
        
        const toast = document.createElement('div');
        toast.className = `toast ${tipo}`;
        toast.textContent = mensaje;
        document.body.appendChild(toast);
        
        setTimeout(() => {
          toast.style.opacity = '0';
          setTimeout(() => toast.remove(), 300);
        }, duracion);
      }
      
      function mostrarMasInfo() {
        if (currentBaldosa) {
          console.log('üìñ Mostrando m√°s info de:', currentBaldosa.nombre);
          if (currentBaldosa.id) {
            window.open(`/baldosa/${currentBaldosa.id}`, '_blank');
          } else {
            alert(`${currentBaldosa.nombre}\n\n${currentBaldosa.descripcion || 'Sin descripci√≥n adicional'}\n\nCategor√≠a: ${currentBaldosa.categoria || 'Hist√≥rico'}\nDirecci√≥n: ${currentBaldosa.direccion || 'Sin direcci√≥n'}`);
          }
        }
      }
      
      function cerrarMemorial() {
        memorialOverlay.style.display = 'none';
        siluetasContainer.innerHTML = '';
      }
      
      function reintentar() {
        window.location.reload();
      }
      
      function calcularDistancia(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const œÜ1 = lat1 * Math.PI / 180;
        const œÜ2 = lat2 * Math.PI / 180;
        const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
        const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
        
        const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
                  Math.cos(œÜ1) * Math.cos(œÜ2) *
                  Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        
        return R * c;
      }
      
      async function verificarPermisoUbicacion() {
        if (!navigator.permissions) {
          return 'prompt';
        }
        
        try {
          const result = await navigator.permissions.query({ name: 'geolocation' });
          return result.state;
        } catch (error) {
          console.log('Error verificando permiso:', error);
          return 'prompt';
        }
      }
      
      function solicitarPermiso() {
        permissionRequestEl.style.display = 'none';
        loadingEl.style.display = 'flex';
        
        navigator.geolocation.getCurrentPosition(
          async (position) => {
            userLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
            await continuarConUbicacion();
          },
          (error) => {
            loadingEl.style.display = 'none';
            permissionDeniedEl.style.display = 'flex';
          },
          { enableHighAccuracy: true, timeout: 15000 }
        );
      }
      
      async function obtenerUbicacion() {
        return new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              resolve({
                lat: position.coords.latitude,
                lng: position.coords.longitude
              });
            },
            (error) => {
              let msg = 'Error obteniendo ubicaci√≥n';
              if (error.code === error.PERMISSION_DENIED) {
                msg = 'Permiso de ubicaci√≥n denegado';
              } else if (error.code === error.POSITION_UNAVAILABLE) {
                msg = 'Ubicaci√≥n no disponible';
              } else if (error.code === error.TIMEOUT) {
                msg = 'Tiempo de espera agotado';
              }
              reject(new Error(msg));
            },
            { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
          );
        });
      }

      async function buscarBaldosasCercanas(lat, lng) {
        const response = await fetch(`/api/baldosas`);
        const data = await response.json();
        return data.baldosas || [];
      }

      async function cargarScriptsAR() {
        if (!window.AFRAME) {
          await new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = 'https://aframe.io/releases/1.4.2/aframe.min.js';
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
          });
        }
        
        await new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js';
          script.onload = () => {
            console.log('‚úÖ aframe-extras cargado');
            resolve();
          };
          script.onerror = () => {
            console.warn('‚ö†Ô∏è aframe-extras no carg√≥');
            resolve();
          };
          document.head.appendChild(script);
        });
        
        if (!window.MINDAR) {
          await new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js';
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
          });
        }
      }

      async function iniciarAR(baldosa) {
        console.log('üöÄ INICIANDO AR');
        console.log('üìã Baldosa:', baldosa.nombre);
        
        loadingText.textContent = 'Cargando experiencia AR...';
        loadingStatus.textContent = `Baldosa: ${baldosa.nombre}`;
        
        await cargarScriptsAR();
        
        const mindUrl = baldosa.mindFileUrl || `/targets/baldosa-${baldosa.id}.mind`;
        
        // NUEVO: Usar portaretrato gen√©rico + foto din√°mica
        const glbUrl = `/models/portaretrato_generico.glb`;
        const fotoUrl = baldosa.fotoVictima || baldosa.imagenUrl || '/images/placeholder.jpg';
        
        console.log('üéØ Archivo .mind:', mindUrl);
        console.log('üéÆ Modelo GLB:', glbUrl);
        console.log('üì∏ Foto v√≠ctima:', fotoUrl);
        
        arContainer.innerHTML = `
          <a-scene
            mindar-image="imageTargetSrc: ${mindUrl}; maxTrack: 1; filterMinCF: 0.0001; filterBeta: 0.001;"
            color-space="sRGB"
            renderer="colorManagement: true, physicallyCorrectLights"
            vr-mode-ui="enabled: false"
            device-orientation-permission-ui="enabled: false"
            style="width: 100%; height: 100%;">
            
            <a-assets timeout="10000">
              <a-asset-item id="modelo-portaretrato" src="${glbUrl}"></a-asset-item>
              <img id="foto-victima" src="${fotoUrl}" crossorigin="anonymous">
            </a-assets>
            
            <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
            
            <a-entity mindar-image-target="targetIndex: 0">
              
              <!-- Portaretrato con animaci√≥n -->
              <a-entity 
                id="portaretrato"
                gltf-model="#modelo-portaretrato"
                position="0 0 0"
                rotation="0 0 0"
                scale="1.0 1.0 1.0"
                animation-mixer="loop: once; timeScale: 1.0; clampWhenFinished: true;">
              </a-entity>
              
              <!-- Foto din√°mica encima del portaretrato -->
              <a-plane
                id="foto-dinamica"
                src="#foto-victima"
                position="0 0 0.06"
                rotation="0 0 0"
                width="0.73"
                height="0.92"
                material="shader: flat; transparent: false"
                visible="false">
              </a-plane>
              
            </a-entity>
          </a-scene>
        `;
        
        arContainer.style.display = 'block';
        
        const scene = arContainer.querySelector('a-scene');
        
        scene.addEventListener('loaded', () => {
          console.log('üé¨ ESCENA AR CARGADA');
          
          // Sincronizar foto con animaci√≥n del portaretrato
          const portaretrato = document.getElementById('portaretrato');
          const fotoDinamica = document.getElementById('foto-dinamica');
          
          if (portaretrato && fotoDinamica) {
            // La foto sigue al portaretrato
            portaretrato.addEventListener('model-loaded', () => {
              console.log('‚úÖ Portaretrato cargado');
              
              // Hacer visible la foto
              setTimeout(() => {
                fotoDinamica.setAttribute('visible', 'true');
                console.log('üì∏ Foto aplicada al portaretrato');
              }, 100);
            });
            
            // Sincronizar transformaci√≥n (copiar posici√≥n/rotaci√≥n del portaretrato)
            setInterval(() => {
              const pos = portaretrato.object3D.position;
              const rot = portaretrato.object3D.rotation;
              
              fotoDinamica.object3D.position.set(pos.x, pos.y, pos.z + 0.022);
              fotoDinamica.object3D.rotation.copy(rot);
            }, 16); // ~60fps
          }
          
          loadingEl.style.display = 'none';
          document.getElementById('btn-mapa').style.display = 'flex';
          document.getElementById('instruction-baldosa-name').textContent = baldosa.nombre;
          document.getElementById('instruction-baldosa-address').textContent = baldosa.direccion || '';
          instructionsEl.style.display = 'block';
          
          setTimeout(() => {
            instructionsEl.style.opacity = '0';
            setTimeout(() => instructionsEl.style.display = 'none', 500);
          }, 3000);
          
          mostrarToast('C√°mara lista. Enfoc√° la baldosa.');
        });
        
        setTimeout(() => {
          const target = arContainer.querySelector('[mindar-image-target]');
          
          if (target) {
            target.addEventListener('targetFound', () => {
              console.log('üéØ ¬°BALDOSA DETECTADA!');
              
              currentBaldosa = baldosa;
              
              instructionsEl.style.display = 'none';
              
              // Mostrar bot√≥n flotante de captura
              btnCapturar.style.display = 'flex';
              
              // Actualizar info panel
              document.getElementById('info-nombre').textContent = baldosa.nombre;
              document.getElementById('info-categoria').textContent = baldosa.categoria || 'Hist√≥rico';
              
              // Mostrar ubicaci√≥n y fecha
              const ubicacionTexto = baldosa.barrio 
                ? `${baldosa.barrio}, Buenos Aires` 
                : baldosa.direccion || 'Buenos Aires';
              document.getElementById('info-ubicacion').textContent = ubicacionTexto;
              document.getElementById('info-fecha').textContent = obtenerFechaHoy();
              
              infoPanelEl.style.display = 'block';
            });
            
            target.addEventListener('targetLost', () => {
              console.log('üëã BALDOSA PERDIDA');
              
              // Ocultar bot√≥n flotante
              btnCapturar.style.display = 'none';
              
              infoPanelEl.style.display = 'none';
              if (memorialOverlay.style.display === 'block') {
                cerrarMemorial();
              }
            });
          }
        }, 1000);
      }

      function mostrarNoBaldosa(baldosas, userLat, userLng) {
        loadingEl.style.display = 'none';
        noBaldosaEl.style.display = 'flex';
        
        if (baldosas.length > 0) {
          let cercana = baldosas[0];
          let distanciaMinima = calcularDistancia(userLat, userLng, cercana.lat, cercana.lng);
          
          baldosas.forEach(b => {
            const d = calcularDistancia(userLat, userLng, b.lat, b.lng);
            if (d < distanciaMinima) {
              distanciaMinima = d;
              cercana = b;
            }
          });
          
          document.getElementById('nearest-info').style.display = 'block';
          document.getElementById('nearest-distance').textContent = 
            distanciaMinima < 1000 ?
              `${Math.round(distanciaMinima)} m` :
              `${(distanciaMinima / 1000).toFixed(1)} km`;
          document.getElementById('nearest-name').textContent = cercana.nombre;
        }
      }

      async function continuarConUbicacion() {
        try {
          loadingText.textContent = 'Buscando baldosas cercanas...';
          
          const baldosas = await buscarBaldosasCercanas(userLocation.lat, userLocation.lng);
          
          console.log(`üìç Encontradas ${baldosas.length} baldosas`);
          
          if (baldosas.length === 0) {
            mostrarToast('No hay baldosas en el sistema a√∫n', 'error', 5000);
            mostrarNoBaldosa([], userLocation.lat, userLocation.lng);
            return;
          }
          
          const baldosasConDistancia = baldosas.map(b => ({
            ...b,
            distancia: calcularDistancia(userLocation.lat, userLocation.lng, b.lat, b.lng)
          }));
          
          baldosaCercana = baldosasConDistancia.sort((a, b) => a.distancia - b.distancia)[0];
          
          console.log(`üéØ Baldosa m√°s cercana: ${baldosaCercana.nombre} a ${Math.round(baldosaCercana.distancia)}m`);
          
          if (baldosaCercana.distancia <= RADIO_MAXIMO) {
            loadingStatus.textContent = `${baldosaCercana.nombre} a ${Math.round(baldosaCercana.distancia)}m`;
            await iniciarAR(baldosaCercana);
          } else {
            console.log(`‚ùå No hay baldosas dentro del radio de ${RADIO_MAXIMO}m`);
            mostrarNoBaldosa(baldosas, userLocation.lat, userLocation.lng);
          }
          
        } catch (error) {
          console.error('Error:', error);
          loadingText.textContent = 'Error';
          loadingStatus.textContent = error.message;
          mostrarToast(error.message, 'error', 5000);
        }
      }

      async function iniciar() {
        const estadoPermiso = await verificarPermisoUbicacion();
        console.log('üîê Estado del permiso:', estadoPermiso);
        
        if (estadoPermiso === 'granted') {
          loadingEl.style.display = 'flex';
          try {
            userLocation = await obtenerUbicacion();
            await continuarConUbicacion();
          } catch (error) {
            loadingEl.style.display = 'none';
            permissionDeniedEl.style.display = 'flex';
          }
        } else if (estadoPermiso === 'denied') {
          permissionDeniedEl.style.display = 'flex';
        } else {
          permissionRequestEl.style.display = 'flex';
        }
      }

      iniciar();
    </script>
  </body>
</html>
