<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="UTF-8">
    <title>Escanear Baldosa - Baldosas por la Memoria</title>
    
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        overflow: hidden;
        background: #1a2a3a;
      }
      
      #loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #1a2a3a;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        color: white;
      }
      
      #loading .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255,255,255,0.2);
        border-top-color: #2563eb;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      
      #loading p {
        font-size: 16px;
        opacity: 0.9;
        text-align: center;
        padding: 0 20px;
      }
      
      #loading .hint {
        font-size: 13px;
        opacity: 0.6;
        margin-top: 10px;
      }
      
      #loading .status {
        margin-top: 20px;
        padding: 10px 20px;
        background: rgba(255,255,255,0.1);
        border-radius: 8px;
        font-size: 14px;
      }
      
      /* Pantalla de solicitud de permiso de ubicaci√≥n */
      #permission-request {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #1a2a3a;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        color: white;
        padding: 30px;
        text-align: center;
      }
      
      #permission-request .icon {
        font-size: 72px;
        margin-bottom: 25px;
        animation: pulse 2s ease-in-out infinite;
      }
      
      @keyframes pulse {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.8; }
      }
      
      #permission-request h2 {
        font-size: 1.6rem;
        margin-bottom: 15px;
        font-weight: 600;
      }
      
      #permission-request p {
        opacity: 0.85;
        margin-bottom: 15px;
        max-width: 400px;
        line-height: 1.5;
      }
      
      #permission-request .why {
        font-size: 0.9rem;
        opacity: 0.7;
        margin-bottom: 30px;
        max-width: 350px;
      }
      
      #permission-request button {
        padding: 15px 40px;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 15px;
      }
      
      #permission-request button:hover {
        background: #1d4ed8;
        transform: scale(1.02);
      }
      
      #permission-request .skip-btn {
        background: transparent;
        border: 2px solid rgba(255,255,255,0.3);
        font-size: 14px;
        padding: 10px 25px;
      }
      
      #permission-request .skip-btn:hover {
        border-color: rgba(255,255,255,0.5);
        background: rgba(255,255,255,0.1);
      }
      
      /* Pantalla de permiso denegado */
      #permission-denied {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #1a2a3a;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        color: white;
        padding: 30px;
        text-align: center;
      }
      
      #permission-denied .icon {
        font-size: 64px;
        margin-bottom: 20px;
      }
      
      #permission-denied h2 {
        font-size: 1.5rem;
        margin-bottom: 15px;
        color: #ef4444;
      }
      
      #permission-denied p {
        opacity: 0.85;
        margin-bottom: 10px;
        max-width: 400px;
        line-height: 1.5;
      }
      
      #permission-denied .instructions {
        background: rgba(255,255,255,0.1);
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
        text-align: left;
        max-width: 350px;
      }
      
      #permission-denied .instructions h3 {
        font-size: 1rem;
        margin-bottom: 10px;
        color: #0ea5e9;
      }
      
      #permission-denied .instructions ol {
        margin-left: 20px;
        font-size: 0.9rem;
        opacity: 0.9;
      }
      
      #permission-denied .instructions li {
        margin-bottom: 8px;
      }
      
      #permission-denied button {
        padding: 12px 30px;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        margin-top: 20px;
      }
      
      /* Pantalla de no hay baldosa cerca */
      #no-baldosa {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #1a2a3a;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9998;
        color: white;
        padding: 30px;
        text-align: center;
      }
      
      #no-baldosa .icon {
        font-size: 64px;
        margin-bottom: 20px;
      }
      
      #no-baldosa h2 {
        font-size: 1.5rem;
        margin-bottom: 15px;
      }
      
      #no-baldosa p {
        opacity: 0.8;
        margin-bottom: 10px;
        max-width: 400px;
      }
      
      #no-baldosa .distance {
        font-size: 2rem;
        font-weight: bold;
        color: #2563eb;
        margin: 20px 0;
      }
      
      #no-baldosa .baldosa-name {
        font-size: 1.1rem;
        color: #0ea5e9;
        margin-bottom: 20px;
      }
      
      #no-baldosa button {
        padding: 12px 30px;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        margin-top: 20px;
      }
      
      #no-baldosa .btn-secondary {
        background: transparent;
        border: 2px solid rgba(255,255,255,0.3);
        margin-left: 10px;
      }
      
      /* Panel de instrucciones */
      #instructions {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(26, 42, 58, 0.95);
        color: white;
        padding: 30px;
        border-radius: 16px;
        text-align: center;
        z-index: 1000;
        max-width: 90%;
        width: 380px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.1);
        box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        transition: opacity 0.5s ease-out;
        display: none;
      }
      
      #instructions .icon {
        font-size: 48px;
        margin-bottom: 15px;
      }
      
      #instructions h2 {
        font-size: 1.4rem;
        margin-bottom: 10px;
        font-weight: 600;
      }
      
      #instructions p {
        font-size: 0.95rem;
        opacity: 0.85;
        line-height: 1.5;
        margin-bottom: 15px;
      }
      
      #instructions .baldosa-info {
        background: rgba(37, 99, 235, 0.2);
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
      }
      
      #instructions .baldosa-info .name {
        font-weight: 600;
        font-size: 1.1rem;
        color: #0ea5e9;
      }
      
      #instructions .baldosa-info .address {
        font-size: 0.85rem;
        opacity: 0.7;
        margin-top: 5px;
      }
      
      /* Panel de informaci√≥n de baldosa detectada */
      #info-panel {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        color: white;
        padding: 0;
        z-index: 1000;
        display: none;
        animation: slideUp 0.3s ease-out;
        overflow: hidden;
      }
      
      #info-panel .baldosa-bg {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: url('/baldoson.jpg');
        background-size: cover;
        background-position: center;
        filter: brightness(0.3);
        z-index: 0;
      }
      
      #info-panel .content {
        position: relative;
        z-index: 1;
        padding: 25px;
        display: flex;
        align-items: flex-start;
        gap: 15px;
        max-width: 600px;
        margin: 0 auto;
      }
      
      #info-panel .checkmark {
        width: 50px;
        height: 50px;
        background: #2563eb;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        flex-shrink: 0;
      }
      
      #info-panel .info-text {
        flex: 1;
      }
      
      #info-panel h3 {
        font-size: 1.3rem;
        margin-bottom: 5px;
        text-shadow: 0 2px 4px rgba(0,0,0,0.5);
      }
      
      #info-panel .categoria {
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: #0ea5e9;
        margin-bottom: 8px;
      }
      
      #info-panel .descripcion {
        font-size: 0.9rem;
        opacity: 0.9;
        line-height: 1.4;
        max-height: 60px;
        overflow: hidden;
        text-shadow: 0 1px 2px rgba(0,0,0,0.5);
      }
      
      #info-panel .btn-mas-info {
        margin-top: 15px;
        padding: 10px 20px;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
      }
      
      #info-panel .btn-mas-info:hover {
        background: #1d4ed8;
        transform: scale(1.02);
      }
      
      /* Placeholder para animaci√≥n 3D de abuelas */
      #abuelas-container {
        position: fixed;
        bottom: 200px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 999;
        display: none;
        pointer-events: none;
      }
      
      #abuelas-container img {
        max-width: 300px;
        max-height: 150px;
      }
      
      /* Overlay de memorial - SIN fondo oscuro */
      #memorial-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 100; /* Muy atr√°s, debajo de todo */
        display: none;
        pointer-events: none;
      }
      
      /* Contenedor de siluetas - muy al fondo */
      #siluetas-container {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        top: 0;
        overflow: hidden;
        pointer-events: none;
        z-index: 100;
      }
      
      .silueta {
        position: absolute;
        width: 50px;
        height: auto;
        opacity: 0;
        animation: aparecerSilueta 0.8s ease-out forwards;
      }
      
      .silueta img {
        width: 100%;
        height: auto;
        opacity: 0.25; /* Mucha m√°s transparencia */
        filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
      }
      
      @keyframes aparecerSilueta {
        0% {
          opacity: 0;
          transform: scale(0.5);
        }
        100% {
          opacity: 1;
          transform: scale(1);
        }
      }
      
      /* GIF de memorial - centrado en pantalla */
      #memorial-gif {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 999;
        max-width: 200px;
        max-height: 200px;
        opacity: 0;
        animation: apareceGif 1s ease-out forwards;
        animation-delay: 2s;
        pointer-events: none;
      }
      
      @keyframes apareceGif {
        0% {
          opacity: 0;
          transform: translate(-50%, -50%) scale(0.5);
        }
        100% {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1);
        }
      }
      
      /* Bot√≥n cerrar memorial */
      #cerrar-memorial {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(26, 42, 58, 0.9);
        border: 1px solid rgba(255,255,255,0.3);
        color: white;
        padding: 10px 20px;
        border-radius: 25px;
        font-size: 14px;
        cursor: pointer;
        z-index: 1001;
        opacity: 0;
        animation: aparecer 0.5s ease-out forwards;
        animation-delay: 1s;
        pointer-events: auto;
      }
      
      @keyframes aparecer {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      #cerrar-memorial:hover {
        background: rgba(37, 99, 235, 0.9);
      }
      
      @media (max-width: 480px) {
        .silueta {
          width: 50px;
        }
        #memorial-gif {
          max-width: 150px;
          max-height: 150px;
        }
      }
      
      @keyframes slideUp {
        from {
          transform: translateY(100%);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      
      #info-panel .content {
        display: flex;
        align-items: flex-start;
        gap: 15px;
        max-width: 600px;
        margin: 0 auto;
      }
      
      #info-panel .checkmark {
        width: 50px;
        height: 50px;
        background: #2563eb;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        flex-shrink: 0;
      }
      
      #info-panel h3 {
        font-size: 1.4rem;
        margin-bottom: 5px;
        font-weight: 600;
      }
      
      #info-panel .categoria {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: #0ea5e9;
        margin-bottom: 10px;
      }
      
      #info-panel .descripcion {
        font-size: 0.95rem;
        line-height: 1.5;
        opacity: 0.9;
      }
      
      /* Bot√≥n volver */
      #btn-volver {
        position: fixed;
        top: 15px;
        left: 15px;
        background: rgba(26, 42, 58, 0.9);
        color: white;
        padding: 10px 18px;
        border-radius: 8px;
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        z-index: 1001;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.1);
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background 0.2s;
      }
      
      #btn-volver:hover {
        background: rgba(26, 42, 58, 1);
      }
      
      /* Bot√≥n ver mapa */
      #btn-mapa {
        position: fixed;
        top: 15px;
        right: 15px;
        background: rgba(37, 99, 235, 0.9);
        color: white;
        padding: 10px 18px;
        border-radius: 8px;
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        z-index: 1001;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.1);
        display: none;
        align-items: center;
        gap: 8px;
        transition: background 0.2s;
      }
      
      #btn-mapa:hover {
        background: rgba(37, 99, 235, 1);
      }
      
      /* Toast notifications */
      .toast {
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: #2563eb;
        color: white;
        padding: 12px 24px;
        border-radius: 25px;
        font-size: 14px;
        z-index: 9999;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        animation: fadeInUp 0.3s ease-out;
      }
      
      .toast.error {
        background: #dc2626;
      }
      
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateX(-50%) translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateX(-50%) translateY(0);
        }
      }
      
      /* AR Scene container */
      #ar-container {
        display: none;
        width: 100%;
        height: 100%;
      }
    </style>
  </head>

  <body>
    <!-- Pantalla de solicitud de permiso -->
    <div id="permission-request">
      <div class="icon">üìç</div>
      <h2>Necesitamos tu ubicaci√≥n</h2>
      <p>Para encontrar las baldosas de la memoria cercanas, necesitamos acceder a tu ubicaci√≥n.</p>
      <p class="why">Tu ubicaci√≥n solo se usa para mostrar baldosas cercanas y no se guarda ni comparte.</p>
      <button onclick="solicitarPermiso()">Permitir ubicaci√≥n</button>
      <button class="skip-btn" onclick="window.location.href='/mapa'">Ver mapa sin ubicaci√≥n</button>
    </div>
    
    <!-- Pantalla de permiso denegado -->
    <div id="permission-denied">
      <div class="icon">üö´</div>
      <h2>Ubicaci√≥n no disponible</h2>
      <p>No pudimos acceder a tu ubicaci√≥n. Para usar el esc√°ner, necesit√°s habilitar el permiso de ubicaci√≥n.</p>
      <div class="instructions">
        <h3>¬øC√≥mo habilitarlo?</h3>
        <ol>
          <li>Toc√° el √≠cono de candado üîí en la barra de direcciones</li>
          <li>Busc√° "Ubicaci√≥n" o "Location"</li>
          <li>Cambi√° a "Permitir"</li>
          <li>Recarg√° la p√°gina</li>
        </ol>
      </div>
      <button onclick="window.location.reload()">üîÑ Reintentar</button>
      <br>
      <a href="/mapa" style="display: inline-block; margin-top: 15px; color: #0ea5e9; text-decoration: none;">Ver mapa sin ubicaci√≥n ‚Üí</a>
    </div>
    
    <!-- Loading -->
    <div id="loading" style="display: none;">
      <div class="spinner"></div>
      <p id="loading-text">Obteniendo tu ubicaci√≥n...</p>
      <p class="hint">Esto puede tardar unos segundos</p>
      <div class="status" id="loading-status"></div>
    </div>
    
    <!-- No hay baldosa cerca -->
    <div id="no-baldosa">
      <div class="icon">üìç</div>
      <h2>No hay baldosas cerca</h2>
      <p>Para escanear una baldosa, necesit√°s estar f√≠sicamente cerca de ella.</p>
      <div id="nearest-info" style="display: none;">
        <p>La baldosa m√°s cercana est√° a:</p>
        <div class="distance" id="nearest-distance">--</div>
        <div class="baldosa-name" id="nearest-name">--</div>
      </div>
      <div>
        <button onclick="reintentar()">üîÑ Actualizar ubicaci√≥n</button>
        <a href="/mapa" class="btn-secondary" style="display: inline-block; padding: 12px 30px; color: white; text-decoration: none; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; margin-left: 10px;">Ver mapa</a>
      </div>
    </div>
    
    <!-- Bot√≥n volver -->
    <a href="/" id="btn-volver">
      ‚Üê Volver
    </a>
    
    <!-- Bot√≥n ver mapa -->
    <a href="/mapa" id="btn-mapa">
      üó∫Ô∏è Ver mapa
    </a>
    
    <!-- Instrucciones -->
    <div id="instructions">
      <div class="icon">üì∑</div>
      <h2>Apunt√° tu c√°mara a la baldosa</h2>
      <p>Est√°s cerca de una baldosa de la memoria. Enfocala con tu c√°mara para ver su historia.</p>
      <div class="baldosa-info">
        <div class="name" id="instruction-baldosa-name">--</div>
        <div class="address" id="instruction-baldosa-address">--</div>
      </div>
    </div>
    
    <!-- Panel de informaci√≥n -->
    <div id="info-panel">
      <div class="baldosa-bg"></div>
      <div class="content">
        <div class="checkmark">‚úì</div>
        <div class="info-text">
          <h3 id="info-nombre">Nombre</h3>
          <div class="categoria" id="info-categoria">Categor√≠a</div>
          <p class="descripcion" id="info-descripcion">Descripci√≥n</p>
          <button class="btn-mas-info" onclick="mostrarMasInfo()">
            üìñ M√°s informaci√≥n
          </button>
        </div>
      </div>
    </div>
    
    <!-- Contenedor para animaci√≥n de abuelas (placeholder) -->
    <div id="abuelas-container">
      <!-- Cuando tengas la animaci√≥n, colocar: -->
      <!-- <img src="/abuelas-animacion.gif" alt="Abuelas levantando baldosa"> -->
    </div>
    
    <!-- Overlay de memorial con siluetas -->
    <div id="memorial-overlay">
      <div id="siluetas-container"></div>
      <!-- GIF de memorial - colocar tu GIF en /public/memorial.gif -->
      <img id="memorial-gif" src="/memorial.gif" alt="Memorial" onerror="this.style.display='none'">
      <button id="cerrar-memorial" onclick="cerrarMemorial()">‚úï Cerrar</button>
    </div>

    <!-- Contenedor AR (se llena din√°micamente) -->
    <div id="ar-container"></div>

    <script>
      // Configuraci√≥n
      const RADIO_MAXIMO = 100; // metros - distancia m√°xima para activar AR
      
      // Estado
      let baldosaCercana = null;
      let currentBaldosa = null; // Baldosa actualmente detectada
      let userLocation = null;
      let arScene = null;
      
      // Elementos DOM
      const loadingEl = document.getElementById('loading');
      const loadingText = document.getElementById('loading-text');
      const loadingStatus = document.getElementById('loading-status');
      const noBaldosaEl = document.getElementById('no-baldosa');
      const instructionsEl = document.getElementById('instructions');
      const infoPanelEl = document.getElementById('info-panel');
      const arContainer = document.getElementById('ar-container');
      const memorialOverlay = document.getElementById('memorial-overlay');
      const siluetasContainer = document.getElementById('siluetas-container');
      const abuelasContainer = document.getElementById('abuelas-container');
      
      // Funci√≥n para mostrar m√°s informaci√≥n
      function mostrarMasInfo() {
        if (currentBaldosa) {
          console.log('üìñ Mostrando m√°s info de:', currentBaldosa.nombre);
          // Redirigir a p√°gina de detalle o mostrar modal
          if (currentBaldosa.id) {
            window.open(`/baldosa/${currentBaldosa.id}`, '_blank');
          } else {
            // Mostrar alerta con info completa si no hay p√°gina de detalle
            alert(`${currentBaldosa.nombre}\n\n${currentBaldosa.descripcion || 'Sin descripci√≥n adicional'}\n\nCategor√≠a: ${currentBaldosa.categoria || 'Hist√≥rico'}\nDirecci√≥n: ${currentBaldosa.direccion || 'No especificada'}`);
          }
        }
      }
      
      // Funci√≥n para mostrar animaci√≥n de abuelas (placeholder)
      function mostrarAbuelasAnimacion() {
        console.log('üëµ Mostrando animaci√≥n de abuelas...');
        // Cuando tengas el GIF/animaci√≥n:
        // abuelasContainer.innerHTML = '<img src="/abuelas-animacion.gif" alt="Abuelas">';
        // abuelasContainer.style.display = 'block';
      }
      
      // Total de im√°genes de siluetas disponibles
      const TOTAL_SILUETAS = 11;
      
      // Mostrar animaci√≥n de memorial - COMENTADO
      function mostrarMemorial() {
        console.log('üé≠ Memorial desactivado - usando modelo GLB');
        // COMENTADO: No mostrar siluetas, solo el modelo 3D
        /*
        console.log('üé≠ Iniciando memorial...');
        memorialOverlay.style.display = 'block';
        siluetasContainer.innerHTML = '';
        
        // Calcular cu√°ntas siluetas necesitamos para llenar la pantalla
        const siluetaSize = 50;
        const cols = Math.ceil(window.innerWidth / siluetaSize) + 2;
        const rows = Math.ceil(window.innerHeight / siluetaSize) + 2;
        const numSiluetas = Math.min(cols * rows, 150); // M√°ximo 150
        
        console.log(`üìä Pantalla: ${window.innerWidth}x${window.innerHeight}, generando ${numSiluetas} siluetas`);
        
        // Agregar siluetas progresivamente
        for (let i = 0; i < numSiluetas; i++) {
          setTimeout(() => {
            agregarSilueta(i, numSiluetas);
          }, i * 50); // 50ms entre cada silueta (m√°s r√°pido)
        }
        */
      }
      
      // COMENTADO: funci√≥n de agregar siluetas
      /*
      function agregarSilueta(index, total) {
        const silueta = document.createElement('div');
        silueta.className = 'silueta';
        
        // N√∫mero de imagen (1 a 11, c√≠clico)
        const numImagen = (index % TOTAL_SILUETAS) + 1;
        
        // Posici√≥n aleatoria cubriendo toda la pantalla
        const randomX = Math.random() * window.innerWidth;
        const randomY = Math.random() * window.innerHeight;
        
        // Tama√±o variable para m√°s naturalidad
        const sizeVariation = 40 + Math.random() * 30; // 40-70px
        
        silueta.style.left = `${randomX}px`;
        silueta.style.top = `${randomY}px`;
        silueta.style.width = `${sizeVariation}px`;
        silueta.style.animationDelay = `${Math.random() * 0.2}s`;
        
        // Ruta: /siluetas/silueta1.png a silueta11.png
        silueta.innerHTML = `<img src="/siluetas/silueta${numImagen}.png" alt="" onerror="console.log('Error cargando silueta'); this.parentElement.remove()">`;
        
        siluetasContainer.appendChild(silueta);
        
        if (index === 0) {
          console.log('Primera silueta agregada');
        }
        if (index === total - 1) {
          console.log('Todas las siluetas agregadas');
        }
      }
      */
      
      function cerrarMemorial() {
        memorialOverlay.style.opacity = '0';
        memorialOverlay.style.transition = 'opacity 0.5s';
        setTimeout(() => {
          memorialOverlay.style.display = 'none';
          memorialOverlay.style.opacity = '1';
        }, 500);
      }

      // Calcular distancia entre dos puntos
      function calcularDistancia(lat1, lng1, lat2, lng2) {
        const R = 6371e3;
        const œÜ1 = (lat1 * Math.PI) / 180;
        const œÜ2 = (lat2 * Math.PI) / 180;
        const ŒîœÜ = ((lat2 - lat1) * Math.PI) / 180;
        const ŒîŒª = ((lng2 - lng1) * Math.PI) / 180;
        const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
                  Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }

      // Mostrar toast
      function mostrarToast(mensaje, tipo = 'info', duracion = 3000) {
        const toast = document.createElement('div');
        toast.className = 'toast' + (tipo === 'error' ? ' error' : '');
        toast.textContent = mensaje;
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.style.opacity = '0';
          toast.style.transition = 'opacity 0.3s';
          setTimeout(() => toast.remove(), 300);
        }, duracion);
      }

      // Obtener ubicaci√≥n del usuario
      async function obtenerUbicacion() {
        return new Promise((resolve, reject) => {
          if (!navigator.geolocation) {
            reject(new Error('Geolocalizaci√≥n no disponible'));
            return;
          }
          
          navigator.geolocation.getCurrentPosition(
            (position) => {
              resolve({
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                accuracy: position.coords.accuracy
              });
            },
            (error) => {
              let msg = 'Error obteniendo ubicaci√≥n';
              if (error.code === error.PERMISSION_DENIED) msg = 'Permiso de ubicaci√≥n denegado';
              if (error.code === error.POSITION_UNAVAILABLE) msg = 'Ubicaci√≥n no disponible';
              if (error.code === error.TIMEOUT) msg = 'Tiempo de espera agotado';
              reject(new Error(msg));
            },
            { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
          );
        });
      }

      // Buscar baldosas cercanas
      async function buscarBaldosasCercanas(lat, lng) {
        const response = await fetch(`/api/baldosas`);
        const data = await response.json();
        return data.baldosas || [];
      }

      // Cargar scripts de AR
      async function cargarScriptsAR() {
        // Cargar A-Frame
        if (!window.AFRAME) {
          await new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = 'https://aframe.io/releases/1.4.2/aframe.min.js';
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
          });
        }
        
        // Cargar aframe-extras (necesario para animation-mixer)
        await new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js';
          script.onload = () => {
            console.log('‚úÖ aframe-extras cargado (animation-mixer disponible)');
            resolve();
          };
          script.onerror = () => {
            console.warn('‚ö†Ô∏è aframe-extras no carg√≥, animaciones pueden no funcionar');
            resolve(); // No fallar, continuar sin animaciones
          };
          document.head.appendChild(script);
        });
        
        // Cargar MindAR
        if (!window.MINDAR) {
          await new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js';
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
          });
        }
      }

      // Iniciar escena AR para una baldosa espec√≠fica
      async function iniciarAR(baldosa) {
        console.log('üöÄ ============================================');
        console.log('üöÄ INICIANDO AR');
        console.log('üöÄ ============================================');
        console.log('üìã Baldosa:', JSON.stringify(baldosa, null, 2));
        
        loadingText.textContent = 'Cargando experiencia AR...';
        loadingStatus.textContent = `Baldosa: ${baldosa.nombre}`;
        
        console.log('üì¶ Cargando scripts AR...');
        await cargarScriptsAR();
        console.log('‚úÖ Scripts AR cargados');
        console.log('   - AFRAME:', typeof window.AFRAME !== 'undefined' ? 'OK' : 'ERROR');
        console.log('   - MINDAR:', typeof window.MINDAR !== 'undefined' ? 'OK' : 'ERROR');
        
        // Determinar URL del archivo .mind
        const mindUrl = baldosa.mindFileUrl || `/targets/baldosa-${baldosa.id}.mind`;
        
        // URL del modelo 3D GLB - CAMBIAR AQU√ç PARA PROBAR
        // Opci√≥n 1: Cubo de prueba
        const glbUrl = `/models/test_cubo.glb`;
        // Opci√≥n 2: Abuelas (descomentar cuando funcione el cubo)
        // const glbUrl = `/models/abuelas_baldosa.glb`;
        
        console.log('üéØ Archivo .mind:', mindUrl);
        console.log('üéÆ Modelo GLB:', glbUrl);
        
        // Verificar si el archivo .mind existe
        try {
          const mindCheck = await fetch(mindUrl, { method: 'HEAD' });
          console.log(`üìÅ .mind existe: ${mindCheck.ok ? 'S√ç' : 'NO'} (status: ${mindCheck.status})`);
        } catch (e) {
          console.log('‚ö†Ô∏è No se pudo verificar .mind:', e.message);
        }
        
        // Verificar si el modelo GLB existe
        try {
          const glbCheck = await fetch(glbUrl, { method: 'HEAD' });
          console.log(`üìÅ .glb existe: ${glbCheck.ok ? 'S√ç' : 'NO'} (status: ${glbCheck.status})`);
        } catch (e) {
          console.log('‚ö†Ô∏è No se pudo verificar .glb:', e.message);
        }
        
        console.log('üèóÔ∏è Creando escena A-Frame con modelo GLB...');
        
        // Crear escena AR solo con el modelo GLB
        arContainer.innerHTML = `
          <a-scene
            mindar-image="imageTargetSrc: ${mindUrl}; maxTrack: 1; filterMinCF: 0.0001; filterBeta: 0.001;"
            color-space="sRGB"
            renderer="colorManagement: true, physicallyCorrectLights"
            vr-mode-ui="enabled: false"
            device-orientation-permission-ui="enabled: false"
            style="width: 100%; height: 100%;">
            
            <a-assets timeout="10000">
              <a-asset-item id="modelo-3d" src="${glbUrl}"></a-asset-item>
            </a-assets>
            
            <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
            
            <a-entity mindar-image-target="targetIndex: 0">
              
              <!-- MODELO 3D GLB -->
              <a-entity 
                id="modelo-principal"
                gltf-model="#modelo-3d"
                position="0 0.3 0"
                rotation="0 0 0"
                scale="0.2 0.2 0.2"
                animation-mixer="loop: repeat; timeScale: 1;">
              </a-entity>
              
              <!-- Cubo de referencia (siempre visible si el target funciona) -->
              <a-box
                position="0 0 0"
                width="0.3"
                height="0.05"
                depth="0.3"
                color="#2563eb"
                opacity="0.8">
              </a-box>
              
            </a-entity>
          </a-scene>
        `;
        
        arContainer.style.display = 'block';
        console.log('‚úÖ Contenedor AR visible');
        
        // Esperar a que la escena cargue
        const scene = arContainer.querySelector('a-scene');
        
        // Debug: escuchar eventos de assets
        scene.addEventListener('loaded', () => {
          console.log('üé¨ ============================================');
          console.log('üé¨ ESCENA AR CARGADA COMPLETAMENTE');
          console.log('üé¨ ============================================');
          
          // Verificar si el modelo se carg√≥
          const modelo = document.getElementById('modelo-principal');
          if (modelo) {
            console.log('üì¶ Elemento modelo encontrado:', modelo);
            
            modelo.addEventListener('model-loaded', () => {
              console.log('‚úÖ ¬°MODELO GLB CARGADO EXITOSAMENTE!');
            });
            
            modelo.addEventListener('model-error', (e) => {
              console.error('‚ùå ERROR cargando modelo GLB:', e);
            });
          } else {
            console.log('‚ö†Ô∏è Elemento modelo no encontrado');
          }
          
          // Verificar assets
          const assets = scene.querySelector('a-assets');
          if (assets) {
            assets.addEventListener('loaded', () => {
              console.log('‚úÖ Assets cargados');
            });
            assets.addEventListener('timeout', () => {
              console.error('‚ùå Timeout cargando assets');
            });
          }
          
          loadingEl.style.display = 'none';
          
          // Mostrar bot√≥n de mapa
          document.getElementById('btn-mapa').style.display = 'flex';
          
          // Mostrar instrucciones
          document.getElementById('instruction-baldosa-name').textContent = baldosa.nombre;
          document.getElementById('instruction-baldosa-address').textContent = baldosa.direccion || '';
          instructionsEl.style.display = 'block';
          
          // Ocultar instrucciones despu√©s de 3 segundos
          setTimeout(() => {
            instructionsEl.style.opacity = '0';
            setTimeout(() => instructionsEl.style.display = 'none', 500);
          }, 3000);
          
          mostrarToast('C√°mara lista. Enfoc√° la baldosa.');
        });
        
        scene.addEventListener('arError', (e) => {
          console.error('Error AR:', e);
          mostrarToast('Error al iniciar la c√°mara', 'error');
        });
        
        // Eventos de detecci√≥n
        setTimeout(() => {
          const target = arContainer.querySelector('[mindar-image-target]');
          console.log('üîç Buscando target element:', target ? 'ENCONTRADO' : 'NO ENCONTRADO');
          
          if (target) {
            console.log('üëÇ Registrando listeners de detecci√≥n...');
            
            target.addEventListener('targetFound', () => {
              console.log('üéØ ============================================');
              console.log('üéØ ¬°BALDOSA DETECTADA!');
              console.log('üéØ ============================================');
              console.log('üéØ Nombre:', baldosa.nombre);
              console.log('üéØ ID:', baldosa.id);
              
              // Guardar baldosa actual para el bot√≥n "M√°s info"
              currentBaldosa = baldosa;
              
              instructionsEl.style.display = 'none';
              document.getElementById('info-nombre').textContent = baldosa.nombre;
              document.getElementById('info-categoria').textContent = baldosa.categoria || 'Hist√≥rico';
              document.getElementById('info-descripcion').textContent = baldosa.descripcion || '';
              infoPanelEl.style.display = 'block';
              
              console.log('üéÆ Modelo GLB deber√≠a estar visible ahora');
              // COMENTADO: No mostrar siluetas memorial
              // mostrarMemorial();
            });
            
            target.addEventListener('targetLost', () => {
              console.log('üëã ============================================');
              console.log('üëã BALDOSA PERDIDA');
              console.log('üëã ============================================');
              infoPanelEl.style.display = 'none';
              // Cerrar memorial si est√° abierto
              if (memorialOverlay.style.display === 'block') {
                console.log('üé≠ Cerrando memorial...');
                cerrarMemorial();
              }
            });
            
            console.log('‚úÖ Listeners registrados correctamente');
          } else {
            console.log('‚ùå ERROR: No se encontr√≥ el elemento target');
          }
        }, 1000);
      }

      // Mostrar pantalla de "no hay baldosa cerca"
      function mostrarNoBaldosa(baldosas, userLat, userLng) {
        loadingEl.style.display = 'none';
        noBaldosaEl.style.display = 'flex';
        
        if (baldosas.length > 0) {
          // Encontrar la m√°s cercana
          let cercana = baldosas[0];
          let distanciaMinima = calcularDistancia(userLat, userLng, cercana.lat, cercana.lng);
          
          baldosas.forEach(b => {
            const d = calcularDistancia(userLat, userLng, b.lat, b.lng);
            if (d < distanciaMinima) {
              distanciaMinima = d;
              cercana = b;
            }
          });
          
          document.getElementById('nearest-info').style.display = 'block';
          document.getElementById('nearest-distance').textContent = 
            distanciaMinima < 1000 ? `${Math.round(distanciaMinima)} metros` : `${(distanciaMinima/1000).toFixed(1)} km`;
          document.getElementById('nearest-name').textContent = cercana.nombre;
        }
      }

      // Reintentar
      async function reintentar() {
        noBaldosaEl.style.display = 'none';
        loadingEl.style.display = 'flex';
        loadingText.textContent = 'Actualizando ubicaci√≥n...';
        loadingStatus.textContent = '';
        await iniciar();
      }

      // Elementos DOM adicionales para permisos
      const permissionRequestEl = document.getElementById('permission-request');
      const permissionDeniedEl = document.getElementById('permission-denied');

      // Verificar estado del permiso de ubicaci√≥n
      async function verificarPermisoUbicacion() {
        // Verificar si el navegador soporta la API de permisos
        if (navigator.permissions && navigator.permissions.query) {
          try {
            const result = await navigator.permissions.query({ name: 'geolocation' });
            return result.state; // 'granted', 'denied', 'prompt'
          } catch (e) {
            // Algunos navegadores no soportan query para geolocation
            return 'prompt';
          }
        }
        return 'prompt'; // Asumir que necesita preguntar
      }

      // Solicitar permiso de ubicaci√≥n
      async function solicitarPermiso() {
        permissionRequestEl.style.display = 'none';
        loadingEl.style.display = 'flex';
        
        try {
          userLocation = await obtenerUbicacion();
          console.log('üìç Ubicaci√≥n obtenida:', userLocation);
          await continuarConUbicacion();
        } catch (error) {
          console.error('Error obteniendo ubicaci√≥n:', error);
          loadingEl.style.display = 'none';
          permissionDeniedEl.style.display = 'flex';
        }
      }

      // Continuar con la ubicaci√≥n obtenida
      async function continuarConUbicacion() {
        try {
          loadingStatus.textContent = `Precisi√≥n: ¬±${Math.round(userLocation.accuracy)}m`;
          
          // 2. Buscar baldosas cercanas
          loadingText.textContent = 'Buscando baldosas cercanas...';
          
          const baldosas = await buscarBaldosasCercanas(userLocation.lat, userLocation.lng);
          console.log('üó∫Ô∏è Baldosas encontradas:', baldosas.length);
          
          // 3. Verificar si hay alguna dentro del radio
          baldosaCercana = null;
          let distanciaMinima = Infinity;
          
          baldosas.forEach(b => {
            const distancia = calcularDistancia(userLocation.lat, userLocation.lng, b.lat, b.lng);
            console.log(`  - ${b.nombre}: ${Math.round(distancia)}m`);
            if (distancia < distanciaMinima) {
              distanciaMinima = distancia;
              if (distancia <= RADIO_MAXIMO) {
                baldosaCercana = { ...b, distancia };
              }
            }
          });
          
          if (baldosaCercana) {
            console.log('‚úÖ Baldosa cercana encontrada:', baldosaCercana.nombre, `(${Math.round(baldosaCercana.distancia)}m)`);
            loadingStatus.textContent = `${baldosaCercana.nombre} a ${Math.round(baldosaCercana.distancia)}m`;
            await iniciarAR(baldosaCercana);
          } else {
            console.log('‚ùå No hay baldosas dentro del radio de', RADIO_MAXIMO, 'm');
            mostrarNoBaldosa(baldosas, userLocation.lat, userLocation.lng);
          }
          
        } catch (error) {
          console.error('Error:', error);
          loadingText.textContent = 'Error';
          loadingStatus.textContent = error.message;
          mostrarToast(error.message, 'error', 5000);
        }
      }

      // Iniciar aplicaci√≥n - verifica permisos primero
      async function iniciar() {
        const estadoPermiso = await verificarPermisoUbicacion();
        console.log('üîê Estado del permiso:', estadoPermiso);
        
        if (estadoPermiso === 'granted') {
          // Permiso ya otorgado, continuar directamente
          loadingEl.style.display = 'flex';
          try {
            userLocation = await obtenerUbicacion();
            await continuarConUbicacion();
          } catch (error) {
            loadingEl.style.display = 'none';
            permissionDeniedEl.style.display = 'flex';
          }
        } else if (estadoPermiso === 'denied') {
          // Permiso denegado, mostrar pantalla de ayuda
          permissionDeniedEl.style.display = 'flex';
        } else {
          // Necesita preguntar, mostrar pantalla de solicitud
          permissionRequestEl.style.display = 'flex';
        }
      }

      // Iniciar
      iniciar();
    </script>
  </body>
</html>
