<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="UTF-8">
    <title>Escanear Baldosa - Baldosas por la Memoria</title>
    
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        overflow: hidden;
        background: #1a2a3a;
      }
      
      /* ========== LOADING ========== */
      
      #loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #1a2a3a;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        color: white;
      }
      
      #loading .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255,255,255,0.2);
        border-top-color: #2563eb;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      
      #loading p {
        font-size: 16px;
        opacity: 0.9;
        text-align: center;
        padding: 0 20px;
      }
      
      #loading .status {
        margin-top: 20px;
        padding: 10px 20px;
        background: rgba(255,255,255,0.1);
        border-radius: 8px;
        font-size: 14px;
      }
      
      /* ========== PERMISSION SCREENS ========== */
      
      #permission-request, #permission-denied {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #1a2a3a;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        color: white;
        padding: 30px;
        text-align: center;
      }
      
      #permission-request .icon,
      #permission-denied .icon {
        font-size: 72px;
        margin-bottom: 25px;
      }
      
      @keyframes pulse {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.8; }
      }
      
      #permission-request .icon {
        animation: pulse 2s ease-in-out infinite;
      }
      
      #permission-request h2,
      #permission-denied h2 {
        font-size: 1.8rem;
        margin-bottom: 15px;
        font-weight: 600;
      }
      
      #permission-request p,
      #permission-denied p {
        font-size: 1rem;
        opacity: 0.85;
        line-height: 1.6;
        margin-bottom: 25px;
        max-width: 450px;
      }
      
      #permission-request button,
      #permission-denied button {
        padding: 12px 30px;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
      }
      
      #permission-request button:hover,
      #permission-denied button:hover {
        background: #1d4ed8;
      }
      
      /* ========== NAVIGATION BUTTONS ========== */
      
      #btn-volver {
        position: fixed;
        top: 15px;
        left: 15px;
        background: rgba(26, 42, 58, 0.9);
        color: white;
        padding: 10px 18px;
        border-radius: 8px;
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        z-index: 1001;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.1);
        transition: background 0.2s;
      }
      
      #btn-volver:hover {
        background: rgba(26, 42, 58, 1);
      }
      
      #btn-mapa {
        position: fixed;
        top: 15px;
        right: 15px;
        background: rgba(37, 99, 235, 0.9);
        color: white;
        padding: 10px 18px;
        border-radius: 8px;
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        z-index: 1001;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.1);
        display: none;
        transition: background 0.2s;
      }
      
      #btn-mapa:hover {
        background: rgba(37, 99, 235, 1);
      }
      
      /* ========== TOAST ========== */
      
      .toast {
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: #2563eb;
        color: white;
        padding: 12px 24px;
        border-radius: 25px;
        font-size: 14px;
        z-index: 9999;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        animation: fadeInUp 0.3s ease-out;
      }
      
      .toast.error {
        background: #dc2626;
      }
      
      .toast.success {
        background: #10b981;
      }
      
      .toast.info {
        background: #0ea5e9;
      }
      
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateX(-50%) translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateX(-50%) translateY(0);
        }
      }
      
      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateX(-50%) translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(-50%) translateY(0);
        }
      }
      
      /* ========== INSTRUCTIONS ========== */
      
      #instructions {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(26, 42, 58, 0.95);
        color: white;
        padding: 30px;
        border-radius: 16px;
        text-align: center;
        z-index: 1000;
        max-width: 90%;
        width: 380px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.1);
        box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        transition: opacity 0.5s ease-out;
        display: none;
      }
      
      #instructions .icon {
        font-size: 48px;
        margin-bottom: 15px;
      }
      
      #instructions h2 {
        font-size: 1.4rem;
        margin-bottom: 10px;
        font-weight: 600;
      }
      
      #instructions p {
        font-size: 0.95rem;
        opacity: 0.85;
        line-height: 1.5;
      }
      
      #instructions .baldosa-info {
        background: rgba(37, 99, 235, 0.2);
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
      }
      
      /* ========== INFO PANEL ========== */
      
      #info-panel {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(26, 42, 58, 0.98), rgba(26, 42, 58, 0.9));
        color: white;
        padding: 0;
        z-index: 1000;
        display: none;
        backdrop-filter: blur(10px);
        border-top: 2px solid rgba(37, 99, 235, 0.5);
      }
      
      #info-panel .baldosa-bg {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, #1a2a3a 0%, #2563eb 100%);
        opacity: 0.1;
        z-index: 0;
      }
      
      #info-panel .content {
        position: relative;
        z-index: 1;
        padding: 15px 18px;
        display: flex;
        align-items: flex-start;
        gap: 10px;
        max-width: 480px;
        margin: 0 auto;
      }
      
      #info-panel .checkmark {
        width: 36px;
        height: 36px;
        background: #2563eb;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        flex-shrink: 0;
      }
      
      #info-panel .info-text {
        flex: 1;
      }
      
      #info-panel h3 {
        font-size: 1.1rem;
        margin-bottom: 3px;
        text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        line-height: 1.2;
      }
      
      #info-panel .categoria {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #0ea5e9;
        margin-bottom: 6px;
      }
      
      #info-panel .info-extra {
        display: flex;
        gap: 10px;
        margin-top: 6px;
        padding-top: 6px;
        border-top: 1px solid rgba(255,255,255,0.15);
        flex-wrap: wrap;
      }
      
      #info-panel .info-item {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 0.7rem;
        opacity: 0.85;
      }
      
      #info-panel .info-item-icon {
        font-size: 0.85rem;
      }
      
      #info-panel .btn-mas-info {
        margin-top: 8px;
        padding: 7px 14px;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        transition: all 0.3s;
        width: 100%;
        justify-content: center;
      }
      
      #info-panel .btn-mas-info:hover {
        background: #1d4ed8;
        transform: scale(1.02);
      }
      
      #info-panel .btn-mas-info:active {
        transform: scale(0.98);
      }
      
      #info-panel .btn-guardar-coleccion {
        margin-top: 6px;
        padding: 7px 14px;
        background: #10b981;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        width: 100%;
        justify-content: center;
        transition: all 0.3s;
      }
      
      #info-panel .btn-guardar-coleccion:hover {
        background: #059669;
        transform: scale(1.02);
      }
      
      #info-panel .btn-guardar-coleccion:active {
        transform: scale(0.98);
      }
      
      /* ========== FLOATING CAPTURE BUTTON ========== */
      
      #btn-capturar {
        position: fixed;
        bottom: 40px;
        right: 20px;
        width: 70px;
        height: 70px;
        background: rgba(37, 99, 235, 0.95);
        border: 4px solid white;
        border-radius: 50%;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1001;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        transition: all 0.3s;
        animation: pulseCapture 2s ease-in-out infinite;
      }
      
      #btn-capturar:hover {
        transform: scale(1.1);
        background: rgba(29, 78, 216, 0.95);
      }
      
      #btn-capturar:active {
        transform: scale(0.95);
      }
      
      #btn-capturar .camera-icon {
        color: white;
        font-size: 28px;
      }
      
      @keyframes pulseCapture {
        0%, 100% {
          box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        50% {
          box-shadow: 0 4px 30px rgba(37, 99, 235, 0.8);
        }
      }
      
      /* ========== AR CONTAINER ========== */
      
      #ar-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: none;
      }
    </style>
  </head>
  
  <body>
    <!-- Loading -->
    <div id="loading">
      <div class="spinner"></div>
      <p id="loading-text">Cargando...</p>
      <p class="status" id="loading-status"></p>
    </div>
    
    <!-- Permission Request -->
    <div id="permission-request">
      <div class="icon">üìçüì∑</div>
      <h2>Permisos Necesarios</h2>
      <p>Para escanear baldosas necesitamos acceso a tu ubicaci√≥n y c√°mara.</p>
      <button onclick="solicitarPermisos()">Permitir Acceso</button>
    </div>
    
    <!-- Permission Denied -->
    <div id="permission-denied">
      <div class="icon">‚ö†Ô∏è</div>
      <h2>Permisos Denegados</h2>
      <p>No podemos continuar sin acceso a la ubicaci√≥n y c√°mara. Por favor, habilitalos en la configuraci√≥n de tu navegador.</p>
      <button onclick="window.location.reload()">Reintentar</button>
      <button onclick="window.location.href='/'" style="margin-top: 10px; background: transparent; border: 1px solid white;">Volver al Inicio</button>
    </div>
    
    <!-- Navigation -->
    <a href="/" id="btn-volver">‚Üê Volver</a>
    <a href="/mapa" id="btn-mapa">üó∫Ô∏è Ver mapa</a>
    
    <!-- Floating Capture Button -->
    <button id="btn-capturar" onclick="capturarYGuardar()">
      <span class="camera-icon">üì∑</span>
    </button>
    
    <!-- Instructions -->
    <div id="instructions">
      <div class="icon">üéØ</div>
      <h2>Apunt√° a la baldosa</h2>
      <p>Enfoc√° la c√°mara hacia la baldosa para ver la experiencia AR</p>
      <div class="baldosa-info">
        <p style="margin: 0; font-weight: 600;" id="instruction-baldosa-name"></p>
        <p style="margin: 5px 0 0 0; font-size: 0.85rem; opacity: 0.8;" id="instruction-baldosa-address"></p>
      </div>
    </div>
    
    <!-- Info Panel -->
    <div id="info-panel">
      <div class="baldosa-bg"></div>
      <div class="content">
        <div class="checkmark">‚úì</div>
        <div class="info-text">
          <h3 id="info-nombre">Nombre</h3>
          <div class="categoria" id="info-categoria">Categor√≠a</div>
          
          <div class="info-extra">
            <div class="info-item">
              <span class="info-item-icon">üìç</span>
              <span id="info-ubicacion">--</span>
            </div>
            <div class="info-item">
              <span class="info-item-icon">üìÖ</span>
              <span id="info-fecha">--</span>
            </div>
          </div>
          
          <button class="btn-mas-info" onclick="window.location.href='/baldosas/' + currentBaldosa?.codigo">
            üìñ M√°s informaci√≥n
          </button>
        </div>
      </div>
    </div>
    
    <!-- AR Container -->
    <div id="ar-container"></div>
    
    <script>
      // =============== GLOBAL STATE ===============
      
      let scriptsLoaded = false;
      let currentBaldosa = null;
      let userLocation = null;
      
      // =============== ELEMENT REFERENCES ===============
      
      const loadingEl = document.getElementById('loading');
      const loadingText = document.getElementById('loading-text');
      const loadingStatus = document.getElementById('loading-status');
      const arContainer = document.getElementById('ar-container');
      const instructionsEl = document.getElementById('instructions');
      const infoPanelEl = document.getElementById('info-panel');
      const permissionRequestEl = document.getElementById('permission-request');
      const permissionDeniedEl = document.getElementById('permission-denied');
      const btnCapturar = document.getElementById('btn-capturar');
      
      // =============== UTILITY FUNCTIONS ===============
      
      function obtenerFechaHoy() {
        const hoy = new Date();
        const opciones = { 
          weekday: 'long', 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        };
        return hoy.toLocaleDateString('es-AR', opciones);
      }
      
      function mostrarToast(mensaje, tipo = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast ${tipo}`;
        toast.textContent = mensaje;
        document.body.appendChild(toast);
        
        setTimeout(() => {
          toast.style.opacity = '0';
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }
      
      // =============== SCREENSHOT FUNCTIONS ===============
      
      async function capturarScreenshot() {
        console.log('üì∏ Iniciando captura...');
        
        return new Promise((resolve) => {
          // DOBLE requestAnimationFrame para asegurar render completo
          requestAnimationFrame(() => {
            console.log('üîÑ RAF 1');
            requestAnimationFrame(() => {
              console.log('üîÑ RAF 2');
              try {
                const scene = document.querySelector('a-scene');
                console.log('üé¨ Scene:', scene ? 'encontrada' : 'NO encontrada');
                
                if (!scene) {
                  console.error('‚ùå No se encontr√≥ la escena A-Frame');
                  resolve(null);
                  return;
                }
                
                const canvas = scene.querySelector('canvas');
                console.log('üñºÔ∏è Canvas:', canvas ? 'encontrado' : 'NO encontrado');
                
                if (!canvas) {
                  console.error('‚ùå No se encontr√≥ el canvas');
                  resolve(null);
                  return;
                }
                
                console.log('üìê Canvas tama√±o:', canvas.width, 'x', canvas.height);
                
                // Verificar p√≠xeles no-negros
                try {
                  const ctx = canvas.getContext('2d');
                  console.log('üé® Context 2D:', ctx ? 'OK' : 'ERROR');
                  
                  if (!ctx) {
                    console.error('‚ùå No se pudo obtener contexto 2D');
                    // Continuar sin validaci√≥n de p√≠xeles
                  } else {
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const pixels = imageData.data;
                    
                    let nonBlackPixels = 0;
                    for (let i = 0; i < pixels.length; i += 4) {
                      if (pixels[i] > 0 || pixels[i+1] > 0 || pixels[i+2] > 0) {
                        nonBlackPixels++;
                      }
                    }
                    
                    const totalPixels = canvas.width * canvas.height;
                    const percentageNonBlack = (nonBlackPixels / totalPixels) * 100;
                    console.log('üé® P√≠xeles activos:', percentageNonBlack.toFixed(1), '%');
                    
                    if (percentageNonBlack < 1) {
                      console.warn('‚ö†Ô∏è Canvas mayormente negro!');
                    }
                  }
                } catch (pixelError) {
                  console.warn('‚ö†Ô∏è No se pudo validar p√≠xeles:', pixelError.message);
                  // Continuar de todos modos
                }
                
                console.log('üîÑ Convirtiendo canvas a DataURL...');
                const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                console.log('üì¶ DataURL generado, tama√±o:', dataUrl ? dataUrl.length : 'NULL');
                
                if (!dataUrl || dataUrl.length < 1000) {
                  console.error('‚ùå Screenshot inv√°lido, length:', dataUrl?.length);
                  resolve(null);
                  return;
                }
                
                const sizeKB = Math.round(dataUrl.length / 1024);
                console.log('‚úÖ Screenshot OK:', sizeKB, 'KB');
                
                resolve(dataUrl);
                
              } catch (error) {
                console.error('‚ùå Error en captura:', error);
                console.error('Error tipo:', error.name);
                console.error('Error mensaje:', error.message);
                console.error('Error stack:', error.stack);
                resolve(null);
              }
            });
          });
        });
      }
      
      async function capturarYGuardar() {
        console.log('üì∏ Proceso de captura...');
        
        if (!currentBaldosa) {
          mostrarToast('Error: baldosa no detectada', 'error');
          return;
        }
        
        // ESPERAR 500ms para render completo
        console.log('‚è≥ Esperando render...');
        await new Promise(resolve => setTimeout(resolve, 500));
        
        const foto = await capturarScreenshot();
        
        if (!foto) {
          mostrarToast('Error capturando foto', 'error');
          return;
        }
        
        if (foto.length < 1000) {
          console.error('‚ùå Foto muy peque√±a');
          mostrarToast('Error: foto inv√°lida', 'error');
          return;
        }
        
        console.log('‚úÖ Foto v√°lida');
        
        // Get collection
        const coleccionStr = localStorage.getItem('baldosas_coleccion');
        let coleccion = { items: [], totalEscaneos: 0 };
        
        if (coleccionStr) {
          try {
            coleccion = JSON.parse(coleccionStr);
          } catch (e) {
            console.error('Error parseando colecci√≥n:', e);
          }
        }
        
        // Check duplicate
        const yaExiste = coleccion.items.some(item => 
          item.baldosaId === (currentBaldosa.codigo || currentBaldosa.id)
        );
        
        if (yaExiste) {
          mostrarToast('Ya ten√©s esta baldosa en tu colecci√≥n', 'info');
          setTimeout(() => {
            window.location.href = '/coleccion';
          }, 1500);
          return;
        }
        
        // Create item
        const nuevoItem = {
          id: `item_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
          baldosaId: currentBaldosa.codigo || currentBaldosa.id,
          nombreVictima: currentBaldosa.nombre,
          fechaDesaparicion: currentBaldosa.fechaDesaparicion || '',
          fechaEscaneo: new Date().toISOString(),
          fotoUrl: foto,
          ubicacion: currentBaldosa.direccion || currentBaldosa.barrio || 'Buenos Aires',
          lat: currentBaldosa.lat,
          lng: currentBaldosa.lng,
          notas: ''
        };
        
        console.log('üíæ Guardando...');
        
        coleccion.items.unshift(nuevoItem);
        coleccion.totalEscaneos = coleccion.items.length;
        coleccion.ultimoEscaneo = nuevoItem.fechaEscaneo;
        
        try {
          localStorage.setItem('baldosas_coleccion', JSON.stringify(coleccion));
          console.log('‚úÖ Guardado en localStorage');
        } catch (e) {
          console.error('‚ùå Error guardando:', e);
          if (e.name === 'QuotaExceededError') {
            mostrarToast('Almacenamiento lleno', 'error');
          } else {
            mostrarToast('Error al guardar', 'error');
          }
          return;
        }
        
        mostrarToast('¬°Foto guardada! üì∏', 'success');
        
        setTimeout(() => {
          window.location.href = '/coleccion';
        }, 1000);
      }
      
      // =============== PERMISSIONS ===============
      
      async function solicitarPermisos() {
        console.log('üìç Solicitando permisos...');
        
        try {
          // Location permission
          const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject);
          });
          
          userLocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          
          console.log('‚úÖ Ubicaci√≥n obtenida:', userLocation);
          
          // Camera permission (will be requested by A-Frame)
          permissionRequestEl.style.display = 'none';
          cargarBaldosa();
          
        } catch (error) {
          console.error('‚ùå Error permisos:', error);
          permissionRequestEl.style.display = 'none';
          permissionDeniedEl.style.display = 'flex';
        }
      }
      
      // =============== LOAD BALDOSA ===============
      
      async function cargarBaldosa() {
        console.log('üîÑ Cargando baldosa...');
        
        const params = new URLSearchParams(window.location.search);
        const baldosaId = params.get('id');
        
        loadingText.textContent = 'Cargando informaci√≥n de la baldosa...';
        
        try {
          let baldosa;
          
          if (baldosaId) {
            // Cargar baldosa espec√≠fica
            console.log('üìã Cargando baldosa ID:', baldosaId);
            const response = await fetch(`/api/baldosas/${baldosaId}`);
            
            console.log('üì° Response status:', response.status);
            console.log('üì° Response ok:', response.ok);
            
            const data = await response.json();
            
            console.log('üì¶ Respuesta API completa:', data);
            console.log('üì¶ Tipo de data:', typeof data);
            console.log('üì¶ Keys de data:', Object.keys(data));
            
            if (!data.baldosa) {
              console.error('‚ùå data.baldosa no existe!');
              console.error('‚ùå data completo:', JSON.stringify(data, null, 2));
              throw new Error('Baldosa no encontrada');
            }
            
            console.log('üì¶ data.baldosa:', data.baldosa);
            console.log('üì¶ Keys de data.baldosa:', Object.keys(data.baldosa));
            
            baldosa = data.baldosa;
            
          } else {
            // Cargar baldosa m√°s cercana o primera disponible
            console.log('üìç Cargando baldosa m√°s cercana...');
            const response = await fetch('/api/baldosas');
            const data = await response.json();
            
            if (!data.baldosas || data.baldosas.length === 0) {
              throw new Error('No hay baldosas disponibles');
            }
            
            // Si hay ubicaci√≥n, buscar la m√°s cercana
            if (userLocation) {
              baldosa = data.baldosas.reduce((closest, current) => {
                const currentDist = calcularDistancia(
                  userLocation.lat, 
                  userLocation.lng,
                  current.ubicacion.coordinates[1],
                  current.ubicacion.coordinates[0]
                );
                
                const closestDist = calcularDistancia(
                  userLocation.lat,
                  userLocation.lng,
                  closest.ubicacion.coordinates[1],
                  closest.ubicacion.coordinates[0]
                );
                
                return currentDist < closestDist ? current : closest;
              });
              
              console.log('üìç Baldosa m√°s cercana:', baldosa.nombre);
            } else {
              // Si no hay ubicaci√≥n, usar la primera
              baldosa = data.baldosas[0];
              console.log('üìã Usando primera baldosa:', baldosa.nombre);
            }
          }
          
          console.log('‚úÖ Baldosa cargada:', baldosa.nombre);
          console.log('üîç Campos de baldosa:', {
            fotoUrl: baldosa.fotoUrl,
            imagenUrl: baldosa.imagenUrl,
            mindFileUrl: baldosa.mindFileUrl
          });
          
          iniciarAR(baldosa);
          
        } catch (error) {
          console.error('‚ùå Error cargando baldosa:', error);
          mostrarToast('Error cargando baldosa', 'error');
          setTimeout(() => window.location.href = '/', 2000);
        }
      }
      
      function calcularDistancia(lat1, lon1, lat2, lon2) {
        const R = 6371; // Radio de la Tierra en km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = 
          Math.sin(dLat/2) * Math.sin(dLat/2) +
          Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
          Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
      }
      
      // =============== LOAD AR SCRIPTS ===============
      
      async function cargarScriptsAR() {
        if (scriptsLoaded) return;
        
        console.log('üì¶ Cargando librer√≠as AR...');
        loadingText.textContent = 'Cargando librer√≠as AR...';
        
        return new Promise((resolve, reject) => {
          const aframe = document.createElement('script');
          aframe.src = 'https://cdn.jsdelivr.net/npm/aframe@1.6.0/dist/aframe-master.min.js';
          
          const mindar = document.createElement('script');
          mindar.src = 'https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js';
          
          aframe.onload = () => {
            console.log('‚úÖ A-Frame cargado');
            document.head.appendChild(mindar);
          };
          
          mindar.onload = () => {
            console.log('‚úÖ MindAR cargado');
            scriptsLoaded = true;
            resolve();
          };
          
          mindar.onerror = () => {
            console.error('‚ùå Error cargando MindAR');
            reject(new Error('Error cargando MindAR'));
          };
          
          document.head.appendChild(aframe);
        });
      }
      
      // =============== INIT AR ===============
      
      async function iniciarAR(baldosa) {
        console.log('üöÄ INICIANDO AR');
        console.log('üìã Baldosa:', baldosa.nombre);
        console.log('üì∏ fotoUrl:', baldosa.fotoUrl);
        
        loadingText.textContent = 'Cargando experiencia AR...';
        loadingStatus.textContent = `Baldosa: ${baldosa.nombre}`;
        
        await cargarScriptsAR();
        
        const mindUrl = baldosa.mindFileUrl || `/targets/baldosa-${baldosa.id}.mind`;
        const glbUrl = `/models/portaretrato_generico.glb`;
        
        // Usar fotoUrl de la baldosa, con fallback a imagenUrl
        const fotoUrl = baldosa.fotoUrl || baldosa.imagenUrl || '/images/placeholder.jpg';
        
        console.log('üéØ Target:', mindUrl);
        console.log('üéÆ Modelo:', glbUrl);
        console.log('üì∏ fotoUrl de baldosa:', baldosa.fotoUrl);
        console.log('üì∏ imagenUrl de baldosa:', baldosa.imagenUrl);
        console.log('üì∏ Foto final a usar:', fotoUrl);
        
        const fotoUrlFinal = fotoUrl;
        
        arContainer.innerHTML = `
          <a-scene
            mindar-image="imageTargetSrc: ${mindUrl}; maxTrack: 1; filterMinCF: 0.0001; filterBeta: 0.001;"
            color-space="sRGB"
            renderer="colorManagement: true, physicallyCorrectLights"
            vr-mode-ui="enabled: false"
            device-orientation-permission-ui="enabled: false"
            style="width: 100%; height: 100%;">
            
            <a-assets timeout="10000">
              <a-asset-item id="modelo-portaretrato" src="${glbUrl}"></a-asset-item>
              <img id="foto-ar" src="${fotoUrlFinal}" crossorigin="anonymous">
            </a-assets>
            
            <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
            
            <a-entity mindar-image-target="targetIndex: 0">
              
              <!-- Grupo contenedor con animaci√≥n de posici√≥n y rotaci√≥n -->
              <a-entity 
                id="portaretrato-grupo" 
                position="0 0 0.02" 
                rotation="90 0 0"
                animation__pos="property: position; to: 0 0 1.0; dur: 3000; easing: easeOutCubic; startEvents: targetFound"
                animation__rot="property: rotation; to: 0 0 0; dur: 3000; easing: easeOutCubic; startEvents: targetFound">
                
                <!-- Portaretrato (modelo 3D sin animaci√≥n propia) -->
                <a-entity 
                  id="portaretrato"
                  gltf-model="#modelo-portaretrato"
                  position="0 0 0"
                  scale="1.0 1.0 1.0">
                </a-entity>
                
                <!-- Foto din√°mica DENTRO del portaretrato -->
                <a-plane
                  id="foto-dinamica"
                  src="#foto-ar"
                  position="0 0 0.025"
                  rotation="0 0 0"
                  width="0.73"
                  height="0.92"
                  material="shader: flat; side: double; transparent: false; alphaTest: 0.1"
                  visible="true">
                </a-plane>
                
              </a-entity>
            </a-entity>
          </a-scene>
        `;
        
        arContainer.style.display = 'block';
        
        const scene = arContainer.querySelector('a-scene');
        
        scene.addEventListener('loaded', () => {
          console.log('üé¨ ESCENA AR CARGADA');
          
          // Check image loaded
          const fotoImg = document.getElementById('foto-ar');
          if (fotoImg) {
            console.log('üñºÔ∏è Elemento foto encontrado');
            console.log('   src configurado:', fotoImg.src);
            console.log('   src esperado:', fotoUrlFinal);
            
            fotoImg.onload = () => {
              console.log('‚úÖ Imagen cargada exitosamente!');
              console.log('   Dimensiones:', fotoImg.naturalWidth, 'x', fotoImg.naturalHeight);
            };
            fotoImg.onerror = (e) => {
              console.error('‚ùå Error cargando imagen');
              console.error('   URL que fall√≥:', fotoUrlFinal);
              console.error('   Error:', e);
            };
          } else {
            console.error('‚ùå No se encontr√≥ elemento foto-ar');
          }
          
          loadingEl.style.display = 'none';
          document.getElementById('btn-mapa').style.display = 'flex';
          document.getElementById('instruction-baldosa-name').textContent = baldosa.nombre;
          document.getElementById('instruction-baldosa-address').textContent = baldosa.direccion || '';
          instructionsEl.style.display = 'block';
          
          setTimeout(() => {
            instructionsEl.style.opacity = '0';
            setTimeout(() => instructionsEl.style.display = 'none', 500);
          }, 3000);
          
          mostrarToast('C√°mara lista. Enfoc√° la baldosa.');
        });
        
        setTimeout(() => {
          const target = arContainer.querySelector('[mindar-image-target]');
          
          if (target) {
            target.addEventListener('targetFound', () => {
              console.log('üéØ ¬°BALDOSA DETECTADA!');
              
              currentBaldosa = baldosa;
              instructionsEl.style.display = 'none';
              btnCapturar.style.display = 'flex';
              
              // Disparar evento para reiniciar animaci√≥n
              const grupo = document.getElementById('portaretrato-grupo');
              if (grupo) {
                console.log('üé¨ Activando animaci√≥n de levantamiento');
                grupo.emit('targetFound');
              }
              
              document.getElementById('info-nombre').textContent = baldosa.nombre;
              document.getElementById('info-categoria').textContent = baldosa.categoria || 'Hist√≥rico';
              
              const ubicacionTexto = baldosa.barrio 
                ? `${baldosa.barrio}, Buenos Aires` 
                : baldosa.direccion || 'Buenos Aires';
              document.getElementById('info-ubicacion').textContent = ubicacionTexto;
              document.getElementById('info-fecha').textContent = obtenerFechaHoy();
              
              infoPanelEl.style.display = 'block';
            });
            
            target.addEventListener('targetLost', () => {
              console.log('üëã BALDOSA PERDIDA');
              btnCapturar.style.display = 'none';
              infoPanelEl.style.display = 'none';
              
              // Resetear posici√≥n para pr√≥xima detecci√≥n
              const grupo = document.getElementById('portaretrato-grupo');
              if (grupo) {
                grupo.setAttribute('position', '0 0 0.02');
                grupo.setAttribute('rotation', '90 0 0');
              }
            });
          }
        }, 1000);
      }
      
      // =============== INIT APP ===============
      
      window.addEventListener('DOMContentLoaded', () => {
        console.log('üöÄ App iniciada');
        permissionRequestEl.style.display = 'flex';
      });
    </script>
  </body>
</html>
