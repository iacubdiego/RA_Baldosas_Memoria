<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="UTF-8">
    <title>Escanear Baldosa - Baldosas por la Memoria</title>
    
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        overflow: hidden;
        background: #1a2a3a;
      }
      
      #loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #1a2a3a;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        color: white;
      }
      
      #loading .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255,255,255,0.2);
        border-top-color: #2563eb;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      
      #loading p {
        font-size: 16px;
        opacity: 0.9;
        text-align: center;
        padding: 0 20px;
      }
      
      #loading .hint {
        font-size: 13px;
        opacity: 0.6;
        margin-top: 10px;
      }
      
      #loading .status {
        margin-top: 20px;
        padding: 10px 20px;
        background: rgba(255,255,255,0.1);
        border-radius: 8px;
        font-size: 14px;
      }
      
      /* Pantalla de no hay baldosa cerca */
      #no-baldosa {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #1a2a3a;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9998;
        color: white;
        padding: 30px;
        text-align: center;
      }
      
      #no-baldosa .icon {
        font-size: 64px;
        margin-bottom: 20px;
      }
      
      #no-baldosa h2 {
        font-size: 1.5rem;
        margin-bottom: 15px;
      }
      
      #no-baldosa p {
        opacity: 0.8;
        margin-bottom: 10px;
        max-width: 400px;
      }
      
      #no-baldosa .distance {
        font-size: 2rem;
        font-weight: bold;
        color: #2563eb;
        margin: 20px 0;
      }
      
      #no-baldosa .baldosa-name {
        font-size: 1.1rem;
        color: #0ea5e9;
        margin-bottom: 20px;
      }
      
      #no-baldosa button {
        padding: 12px 30px;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        margin-top: 20px;
      }
      
      #no-baldosa .btn-secondary {
        background: transparent;
        border: 2px solid rgba(255,255,255,0.3);
        margin-left: 10px;
      }
      
      /* Panel de instrucciones */
      #instructions {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(26, 42, 58, 0.95);
        color: white;
        padding: 30px;
        border-radius: 16px;
        text-align: center;
        z-index: 1000;
        max-width: 90%;
        width: 380px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.1);
        box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        transition: opacity 0.5s ease-out;
        display: none;
      }
      
      #instructions .icon {
        font-size: 48px;
        margin-bottom: 15px;
      }
      
      #instructions h2 {
        font-size: 1.4rem;
        margin-bottom: 10px;
        font-weight: 600;
      }
      
      #instructions p {
        font-size: 0.95rem;
        opacity: 0.85;
        line-height: 1.5;
        margin-bottom: 15px;
      }
      
      #instructions .baldosa-info {
        background: rgba(37, 99, 235, 0.2);
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
      }
      
      #instructions .baldosa-info .name {
        font-weight: 600;
        font-size: 1.1rem;
        color: #0ea5e9;
      }
      
      #instructions .baldosa-info .address {
        font-size: 0.85rem;
        opacity: 0.7;
        margin-top: 5px;
      }
      
      /* Panel de informaci√≥n de baldosa detectada */
      #info-panel {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(26, 42, 58, 0.98), rgba(26, 42, 58, 0.9));
        color: white;
        padding: 25px;
        z-index: 1000;
        backdrop-filter: blur(10px);
        border-top: 3px solid #2563eb;
        display: none;
        animation: slideUp 0.3s ease-out;
      }
      
      @keyframes slideUp {
        from {
          transform: translateY(100%);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      
      #info-panel .content {
        display: flex;
        align-items: flex-start;
        gap: 15px;
        max-width: 600px;
        margin: 0 auto;
      }
      
      #info-panel .checkmark {
        width: 50px;
        height: 50px;
        background: #2563eb;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        flex-shrink: 0;
      }
      
      #info-panel h3 {
        font-size: 1.4rem;
        margin-bottom: 5px;
        font-weight: 600;
      }
      
      #info-panel .categoria {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: #0ea5e9;
        margin-bottom: 10px;
      }
      
      #info-panel .descripcion {
        font-size: 0.95rem;
        line-height: 1.5;
        opacity: 0.9;
      }
      
      /* Bot√≥n volver */
      #btn-volver {
        position: fixed;
        top: 15px;
        left: 15px;
        background: rgba(26, 42, 58, 0.9);
        color: white;
        padding: 10px 18px;
        border-radius: 8px;
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        z-index: 1001;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.1);
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background 0.2s;
      }
      
      #btn-volver:hover {
        background: rgba(26, 42, 58, 1);
      }
      
      /* Bot√≥n ver mapa */
      #btn-mapa {
        position: fixed;
        top: 15px;
        right: 15px;
        background: rgba(37, 99, 235, 0.9);
        color: white;
        padding: 10px 18px;
        border-radius: 8px;
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        z-index: 1001;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.1);
        display: none;
        align-items: center;
        gap: 8px;
        transition: background 0.2s;
      }
      
      #btn-mapa:hover {
        background: rgba(37, 99, 235, 1);
      }
      
      /* Toast notifications */
      .toast {
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: #2563eb;
        color: white;
        padding: 12px 24px;
        border-radius: 25px;
        font-size: 14px;
        z-index: 9999;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        animation: fadeInUp 0.3s ease-out;
      }
      
      .toast.error {
        background: #dc2626;
      }
      
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateX(-50%) translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateX(-50%) translateY(0);
        }
      }
      
      /* AR Scene container */
      #ar-container {
        display: none;
        width: 100%;
        height: 100%;
      }
    </style>
  </head>

  <body>
    <!-- Loading -->
    <div id="loading">
      <div class="spinner"></div>
      <p id="loading-text">Obteniendo tu ubicaci√≥n...</p>
      <p class="hint">Permitir acceso a la ubicaci√≥n cuando se solicite</p>
      <div class="status" id="loading-status"></div>
    </div>
    
    <!-- No hay baldosa cerca -->
    <div id="no-baldosa">
      <div class="icon">üìç</div>
      <h2>No hay baldosas cerca</h2>
      <p>Para escanear una baldosa, necesit√°s estar f√≠sicamente cerca de ella.</p>
      <div id="nearest-info" style="display: none;">
        <p>La baldosa m√°s cercana est√° a:</p>
        <div class="distance" id="nearest-distance">--</div>
        <div class="baldosa-name" id="nearest-name">--</div>
      </div>
      <div>
        <button onclick="reintentar()">üîÑ Actualizar ubicaci√≥n</button>
        <a href="/mapa" class="btn-secondary" style="display: inline-block; padding: 12px 30px; color: white; text-decoration: none; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; margin-left: 10px;">Ver mapa</a>
      </div>
    </div>
    
    <!-- Bot√≥n volver -->
    <a href="/" id="btn-volver">
      ‚Üê Volver
    </a>
    
    <!-- Bot√≥n ver mapa -->
    <a href="/mapa" id="btn-mapa">
      üó∫Ô∏è Ver mapa
    </a>
    
    <!-- Instrucciones -->
    <div id="instructions">
      <div class="icon">üì∑</div>
      <h2>Apunt√° tu c√°mara a la baldosa</h2>
      <p>Est√°s cerca de una baldosa de la memoria. Enfocala con tu c√°mara para ver su historia.</p>
      <div class="baldosa-info">
        <div class="name" id="instruction-baldosa-name">--</div>
        <div class="address" id="instruction-baldosa-address">--</div>
      </div>
    </div>
    
    <!-- Panel de informaci√≥n -->
    <div id="info-panel">
      <div class="content">
        <div class="checkmark">‚úì</div>
        <div>
          <h3 id="info-nombre">Nombre</h3>
          <div class="categoria" id="info-categoria">Categor√≠a</div>
          <p class="descripcion" id="info-descripcion">Descripci√≥n</p>
        </div>
      </div>
    </div>

    <!-- Contenedor AR (se llena din√°micamente) -->
    <div id="ar-container"></div>

    <script>
      // Configuraci√≥n
      const RADIO_MAXIMO = 1000; // metros - distancia m√°xima para activar AR
      
      // Estado
      let baldosaCercana = null;
      let userLocation = null;
      let arScene = null;
      
      // Elementos DOM
      const loadingEl = document.getElementById('loading');
      const loadingText = document.getElementById('loading-text');
      const loadingStatus = document.getElementById('loading-status');
      const noBaldosaEl = document.getElementById('no-baldosa');
      const instructionsEl = document.getElementById('instructions');
      const infoPanelEl = document.getElementById('info-panel');
      const arContainer = document.getElementById('ar-container');

      // Calcular distancia entre dos puntos
      function calcularDistancia(lat1, lng1, lat2, lng2) {
        const R = 6371e3;
        const œÜ1 = (lat1 * Math.PI) / 180;
        const œÜ2 = (lat2 * Math.PI) / 180;
        const ŒîœÜ = ((lat2 - lat1) * Math.PI) / 180;
        const ŒîŒª = ((lng2 - lng1) * Math.PI) / 180;
        const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
                  Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }

      // Mostrar toast
      function mostrarToast(mensaje, tipo = 'info', duracion = 3000) {
        const toast = document.createElement('div');
        toast.className = 'toast' + (tipo === 'error' ? ' error' : '');
        toast.textContent = mensaje;
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.style.opacity = '0';
          toast.style.transition = 'opacity 0.3s';
          setTimeout(() => toast.remove(), 300);
        }, duracion);
      }

      // Obtener ubicaci√≥n del usuario
      async function obtenerUbicacion() {
        return new Promise((resolve, reject) => {
          if (!navigator.geolocation) {
            reject(new Error('Geolocalizaci√≥n no disponible'));
            return;
          }
          
          navigator.geolocation.getCurrentPosition(
            (position) => {
              resolve({
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                accuracy: position.coords.accuracy
              });
            },
            (error) => {
              let msg = 'Error obteniendo ubicaci√≥n';
              if (error.code === error.PERMISSION_DENIED) msg = 'Permiso de ubicaci√≥n denegado';
              if (error.code === error.POSITION_UNAVAILABLE) msg = 'Ubicaci√≥n no disponible';
              if (error.code === error.TIMEOUT) msg = 'Tiempo de espera agotado';
              reject(new Error(msg));
            },
            { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
          );
        });
      }

      // Buscar baldosas cercanas
      async function buscarBaldosasCercanas(lat, lng) {
        const response = await fetch(`/api/baldosas`);
        const data = await response.json();
        return data.baldosas || [];
      }

      // Cargar scripts de AR
      async function cargarScriptsAR() {
        // Cargar A-Frame
        if (!window.AFRAME) {
          await new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = 'https://aframe.io/releases/1.4.2/aframe.min.js';
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
          });
        }
        
        // Cargar MindAR
        if (!window.MINDAR) {
          await new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js';
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
          });
        }
      }

      // Iniciar escena AR para una baldosa espec√≠fica
      async function iniciarAR(baldosa) {
        loadingText.textContent = 'Cargando experiencia AR...';
        loadingStatus.textContent = `Baldosa: ${baldosa.nombre}`;
        
        await cargarScriptsAR();
        
        // Determinar URL del archivo .mind
        const mindUrl = baldosa.mindFileUrl || `/targets/baldosa-${baldosa.id}.mind`;
        
        console.log('Cargando .mind desde:', mindUrl);
        
        // Crear escena AR
        arContainer.innerHTML = `
          <a-scene
            mindar-image="imageTargetSrc: ${mindUrl}; maxTrack: 1; filterMinCF: 0.0001; filterBeta: 0.001;"
            color-space="sRGB"
            renderer="colorManagement: true, physicallyCorrectLights"
            vr-mode-ui="enabled: false"
            device-orientation-permission-ui="enabled: false"
            style="width: 100%; height: 100%;">
            
            <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
            
            <a-entity mindar-image-target="targetIndex: 0">
              <a-plane
                position="0 0.15 0"
                height="0.55"
                width="0.85"
                color="#ffffff"
                opacity="0.95"
                material="shader: flat">
              </a-plane>
              
              <a-plane
                position="0 0.38 0.001"
                height="0.08"
                width="0.85"
                color="#2563eb"
                material="shader: flat">
              </a-plane>
              
              <a-text
                value="${baldosa.nombre.toUpperCase()}"
                position="0 0.25 0.01"
                align="center"
                color="#1a2a3a"
                width="1.4"
                wrap-count="25">
              </a-text>
              
              <a-text
                value="${(baldosa.categoria || 'HISTORICO').toUpperCase()}"
                position="0 0.12 0.01"
                align="center"
                color="#2563eb"
                width="0.8">
              </a-text>
              
              <a-text
                value="${(baldosa.mensajeAR || baldosa.descripcion || '').substring(0, 80)}"
                position="0 -0.02 0.01"
                align="center"
                color="#4a6b7c"
                width="1.2"
                wrap-count="30">
              </a-text>
            </a-entity>
          </a-scene>
        `;
        
        arContainer.style.display = 'block';
        
        // Esperar a que la escena cargue
        const scene = arContainer.querySelector('a-scene');
        
        scene.addEventListener('loaded', () => {
          console.log('‚úÖ Escena AR cargada');
          loadingEl.style.display = 'none';
          
          // Mostrar bot√≥n de mapa
          document.getElementById('btn-mapa').style.display = 'flex';
          
          // Mostrar instrucciones
          document.getElementById('instruction-baldosa-name').textContent = baldosa.nombre;
          document.getElementById('instruction-baldosa-address').textContent = baldosa.direccion || '';
          instructionsEl.style.display = 'block';
          
          // Ocultar instrucciones despu√©s de 3 segundos
          setTimeout(() => {
            instructionsEl.style.opacity = '0';
            setTimeout(() => instructionsEl.style.display = 'none', 500);
          }, 3000);
          
          mostrarToast('C√°mara lista. Enfoc√° la baldosa.');
        });
        
        scene.addEventListener('arError', (e) => {
          console.error('Error AR:', e);
          mostrarToast('Error al iniciar la c√°mara', 'error');
        });
        
        // Eventos de detecci√≥n
        setTimeout(() => {
          const target = arContainer.querySelector('[mindar-image-target]');
          if (target) {
            target.addEventListener('targetFound', () => {
              console.log('üéØ Baldosa detectada:', baldosa.nombre);
              instructionsEl.style.display = 'none';
              document.getElementById('info-nombre').textContent = baldosa.nombre;
              document.getElementById('info-categoria').textContent = baldosa.categoria || 'Hist√≥rico';
              document.getElementById('info-descripcion').textContent = baldosa.descripcion || '';
              infoPanelEl.style.display = 'block';
            });
            
            target.addEventListener('targetLost', () => {
              console.log('üëã Baldosa perdida');
              infoPanelEl.style.display = 'none';
            });
          }
        }, 1000);
      }

      // Mostrar pantalla de "no hay baldosa cerca"
      function mostrarNoBaldosa(baldosas, userLat, userLng) {
        loadingEl.style.display = 'none';
        noBaldosaEl.style.display = 'flex';
        
        if (baldosas.length > 0) {
          // Encontrar la m√°s cercana
          let cercana = baldosas[0];
          let distanciaMinima = calcularDistancia(userLat, userLng, cercana.lat, cercana.lng);
          
          baldosas.forEach(b => {
            const d = calcularDistancia(userLat, userLng, b.lat, b.lng);
            if (d < distanciaMinima) {
              distanciaMinima = d;
              cercana = b;
            }
          });
          
          document.getElementById('nearest-info').style.display = 'block';
          document.getElementById('nearest-distance').textContent = 
            distanciaMinima < 1000 ? `${Math.round(distanciaMinima)} metros` : `${(distanciaMinima/1000).toFixed(1)} km`;
          document.getElementById('nearest-name').textContent = cercana.nombre;
        }
      }

      // Reintentar
      async function reintentar() {
        noBaldosaEl.style.display = 'none';
        loadingEl.style.display = 'flex';
        loadingText.textContent = 'Actualizando ubicaci√≥n...';
        loadingStatus.textContent = '';
        await iniciar();
      }

      // Iniciar aplicaci√≥n
      async function iniciar() {
        try {
          // 1. Obtener ubicaci√≥n
          loadingText.textContent = 'Obteniendo tu ubicaci√≥n...';
          loadingStatus.textContent = 'Esto puede tardar unos segundos';
          
          userLocation = await obtenerUbicacion();
          console.log('üìç Ubicaci√≥n:', userLocation);
          loadingStatus.textContent = `Precisi√≥n: ¬±${Math.round(userLocation.accuracy)}m`;
          
          // 2. Buscar baldosas cercanas
          loadingText.textContent = 'Buscando baldosas cercanas...';
          
          const baldosas = await buscarBaldosasCercanas(userLocation.lat, userLocation.lng);
          console.log('üó∫Ô∏è Baldosas encontradas:', baldosas.length);
          
          // 3. Verificar si hay alguna dentro del radio
          baldosaCercana = null;
          let distanciaMinima = Infinity;
          
          baldosas.forEach(b => {
            const distancia = calcularDistancia(userLocation.lat, userLocation.lng, b.lat, b.lng);
            console.log(`  - ${b.nombre}: ${Math.round(distancia)}m`);
            if (distancia < distanciaMinima) {
              distanciaMinima = distancia;
              if (distancia <= RADIO_MAXIMO) {
                baldosaCercana = { ...b, distancia };
              }
            }
          });
          
          if (baldosaCercana) {
            console.log('‚úÖ Baldosa cercana encontrada:', baldosaCercana.nombre, `(${Math.round(baldosaCercana.distancia)}m)`);
            loadingStatus.textContent = `${baldosaCercana.nombre} a ${Math.round(baldosaCercana.distancia)}m`;
            await iniciarAR(baldosaCercana);
          } else {
            console.log('‚ùå No hay baldosas dentro del radio de', RADIO_MAXIMO, 'm');
            mostrarNoBaldosa(baldosas, userLocation.lat, userLocation.lng);
          }
          
        } catch (error) {
          console.error('Error:', error);
          loadingText.textContent = 'Error';
          loadingStatus.textContent = error.message;
          mostrarToast(error.message, 'error', 5000);
        }
      }

      // Iniciar
      iniciar();
    </script>
  </body>
</html>
