<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="UTF-8">
    <title>Escanear Baldosa - Baldosas por la Memoria</title>
    
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        overflow: hidden;
        background: #1a2a3a;
      }
      
      /* ========== LOADING ========== */
      
      #loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #1a2a3a;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        color: white;
      }
      
      #loading .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255,255,255,0.2);
        border-top-color: #2563eb;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      
      #loading p {
        font-size: 16px;
        opacity: 0.9;
        text-align: center;
        padding: 0 20px;
      }
      
      #loading .status {
        margin-top: 20px;
        padding: 10px 20px;
        background: rgba(255,255,255,0.1);
        border-radius: 8px;
        font-size: 14px;
      }
      
      /* ========== PERMISSION SCREENS ========== */
      
      #permission-request, #permission-denied {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #1a2a3a;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        color: white;
        padding: 30px;
        text-align: center;
      }
      
      #permission-request .icon,
      #permission-denied .icon {
        font-size: 72px;
        margin-bottom: 25px;
      }
      
      @keyframes pulse {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.8; }
      }
      
      #permission-request .icon {
        animation: pulse 2s ease-in-out infinite;
      }
      
      #permission-request h2,
      #permission-denied h2 {
        font-size: 1.8rem;
        margin-bottom: 15px;
        font-weight: 600;
      }
      
      #permission-request p,
      #permission-denied p {
        font-size: 1rem;
        opacity: 0.85;
        line-height: 1.6;
        margin-bottom: 25px;
        max-width: 450px;
      }
      
      #permission-request button,
      #permission-denied button {
        padding: 12px 30px;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
      }
      
      #permission-request button:hover,
      #permission-denied button:hover {
        background: #1d4ed8;
      }
      
      /* ========== NAVIGATION BUTTONS ========== */
      
      #btn-volver {
        position: fixed;
        top: 15px;
        left: 15px;
        background: rgba(26, 42, 58, 0.9);
        color: white;
        padding: 10px 18px;
        border-radius: 8px;
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        z-index: 1001;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.1);
        transition: background 0.2s;
      }
      
      #btn-volver:hover {
        background: rgba(26, 42, 58, 1);
      }
      
      #btn-mapa {
        position: fixed;
        top: 15px;
        right: 15px;
        background: rgba(37, 99, 235, 0.9);
        color: white;
        padding: 10px 18px;
        border-radius: 8px;
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        z-index: 1001;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.1);
        display: none;
        transition: background 0.2s;
      }
      
      #btn-mapa:hover {
        background: rgba(37, 99, 235, 1);
      }
      
      /* ========== TOAST ========== */
      
      .toast {
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: #2563eb;
        color: white;
        padding: 12px 24px;
        border-radius: 25px;
        font-size: 14px;
        z-index: 9999;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        animation: fadeInUp 0.3s ease-out;
      }
      
      .toast.error {
        background: #dc2626;
      }
      
      .toast.success {
        background: #10b981;
      }
      
      .toast.info {
        background: #0ea5e9;
      }
      
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateX(-50%) translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateX(-50%) translateY(0);
        }
      }
      
      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateX(-50%) translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(-50%) translateY(0);
        }
      }
      
      /* ========== INSTRUCTIONS ========== */
      
      #instructions {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(26, 42, 58, 0.95);
        color: white;
        padding: 30px;
        border-radius: 16px;
        text-align: center;
        z-index: 1000;
        max-width: 90%;
        width: 380px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.1);
        box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        transition: opacity 0.5s ease-out;
        display: none;
      }
      
      #instructions .icon {
        font-size: 48px;
        margin-bottom: 15px;
      }
      
      #instructions h2 {
        font-size: 1.4rem;
        margin-bottom: 10px;
        font-weight: 600;
      }
      
      #instructions p {
        font-size: 0.95rem;
        opacity: 0.85;
        line-height: 1.5;
      }
      
      #instructions .baldosa-info {
        background: rgba(37, 99, 235, 0.2);
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
      }
      
      /* ========== INFO PANEL ========== */
      
      #info-panel {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(26, 42, 58, 0.98), rgba(26, 42, 58, 0.9));
        color: white;
        padding: 0;
        z-index: 1000;
        display: none;
        backdrop-filter: blur(10px);
        border-top: 2px solid rgba(37, 99, 235, 0.5);
      }
      
      #info-panel .baldosa-bg {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, #1a2a3a 0%, #2563eb 100%);
        opacity: 0.1;
        z-index: 0;
      }
      
      #info-panel .content {
        position: relative;
        z-index: 1;
        padding: 15px 18px;
        display: flex;
        align-items: flex-start;
        gap: 10px;
        max-width: 480px;
        margin: 0 auto;
      }
      
      #info-panel .checkmark {
        width: 36px;
        height: 36px;
        background: #2563eb;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        flex-shrink: 0;
      }
      
      #info-panel .info-text {
        flex: 1;
      }
      
      #info-panel h3 {
        font-size: 1.1rem;
        margin-bottom: 3px;
        text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        line-height: 1.2;
      }
      
      #info-panel .categoria {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #0ea5e9;
        margin-bottom: 6px;
      }
      
      #info-panel .info-extra {
        display: flex;
        gap: 10px;
        margin-top: 6px;
        padding-top: 6px;
        border-top: 1px solid rgba(255,255,255,0.15);
        flex-wrap: wrap;
      }
      
      #info-panel .info-item {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 0.7rem;
        opacity: 0.85;
      }
      
      #info-panel .info-item-icon {
        font-size: 0.85rem;
      }
      
      #info-panel .btn-mas-info {
        margin-top: 8px;
        padding: 7px 14px;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        transition: all 0.3s;
        width: 100%;
        justify-content: center;
      }
      
      #info-panel .btn-mas-info:hover {
        background: #1d4ed8;
        transform: scale(1.02);
      }
      
      #info-panel .btn-mas-info:active {
        transform: scale(0.98);
      }
      
      #info-panel .btn-guardar-coleccion {
        margin-top: 6px;
        padding: 7px 14px;
        background: #10b981;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        width: 100%;
        justify-content: center;
        transition: all 0.3s;
      }
      
      #info-panel .btn-guardar-coleccion:hover {
        background: #059669;
        transform: scale(1.02);
      }
      
      #info-panel .btn-guardar-coleccion:active {
        transform: scale(0.98);
      }
      
      /* ========== FLOATING CAPTURE BUTTON ========== */
      
      #btn-capturar {
        position: fixed;
        bottom: 40px;
        right: 20px;
        width: 70px;
        height: 70px;
        background: rgba(37, 99, 235, 0.95);
        border: 4px solid white;
        border-radius: 50%;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1001;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        transition: all 0.3s;
        animation: pulseCapture 2s ease-in-out infinite;
      }
      
      #btn-capturar:hover {
        transform: scale(1.1);
        background: rgba(29, 78, 216, 0.95);
      }
      
      #btn-capturar:active {
        transform: scale(0.95);
      }
      
      #btn-capturar .camera-icon {
        color: white;
        font-size: 28px;
      }
      
      @keyframes pulseCapture {
        0%, 100% {
          box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        50% {
          box-shadow: 0 4px 30px rgba(37, 99, 235, 0.8);
        }
      }
      
      /* ========== AR CONTAINER ========== */
      
      #ar-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: none;
      }
    </style>
  </head>
  
  <body>
    <!-- Loading -->
    <div id="loading">
      <div class="spinner"></div>
      <p id="loading-text">Cargando...</p>
      <p class="status" id="loading-status"></p>
    </div>
    
    <!-- Permission Request -->
    <div id="permission-request">
      <div class="icon">ğŸ“ğŸ“·</div>
      <h2>Permisos Necesarios</h2>
      <p>Para escanear baldosas necesitamos acceso a tu ubicaciÃ³n y cÃ¡mara.</p>
      <button onclick="solicitarPermisos()">Permitir Acceso</button>
    </div>
    
    <!-- Permission Denied -->
    <div id="permission-denied">
      <div class="icon">âš ï¸</div>
      <h2>Permisos Denegados</h2>
      <p>No podemos continuar sin acceso a la ubicaciÃ³n y cÃ¡mara. Por favor, habilitalos en la configuraciÃ³n de tu navegador.</p>
      <button onclick="window.location.reload()">Reintentar</button>
      <button onclick="window.location.href='/'" style="margin-top: 10px; background: transparent; border: 1px solid white;">Volver al Inicio</button>
    </div>
    
    <!-- Navigation -->
    <a href="/" id="btn-volver">â† Volver</a>
    <a href="/mapa" id="btn-mapa">ğŸ—ºï¸ Ver mapa</a>
    
    <!-- Floating Capture Button -->
    <button id="btn-capturar" onclick="capturarYGuardar()">
      <span class="camera-icon">ğŸ“·</span>
    </button>
    
    <!-- Instructions -->
    <div id="instructions">
      <div class="icon">ğŸ¯</div>
      <h2>ApuntÃ¡ a la baldosa</h2>
      <p>EnfocÃ¡ la cÃ¡mara hacia la baldosa para ver la experiencia AR</p>
      <div class="baldosa-info">
        <p style="margin: 0; font-weight: 600;" id="instruction-baldosa-name"></p>
        <p style="margin: 5px 0 0 0; font-size: 0.85rem; opacity: 0.8;" id="instruction-baldosa-address"></p>
      </div>
    </div>
    
    <!-- Info Panel -->
    <div id="info-panel">
      <div class="baldosa-bg"></div>
      <div class="content">
        <div class="checkmark">âœ“</div>
        <div class="info-text">
          <h3 id="info-nombre">Nombre</h3>
          
          <div class="info-extra">
            <div class="info-item">
              <span class="info-item-icon">ğŸ“</span>
              <span id="info-ubicacion">--</span>
            </div>
            <div class="info-item">
              <span class="info-item-icon">ğŸ“…</span>
              <span id="info-fecha">--</span>
            </div>
          </div>
          
          <button class="btn-mas-info" onclick="window.location.href='/baldosas/' + currentBaldosa?.codigo">
            ğŸ“– MÃ¡s informaciÃ³n
          </button>
        </div>
      </div>
    </div>
    
    <!-- AR Container -->
    <div id="ar-container"></div>
    
    <script>
      // =============== GLOBAL STATE ===============
      
      let scriptsLoaded = false;
      let currentBaldosa = null;
      let userLocation = null;
      
      // =============== ELEMENT REFERENCES ===============
      
      const loadingEl = document.getElementById('loading');
      const loadingText = document.getElementById('loading-text');
      const loadingStatus = document.getElementById('loading-status');
      const arContainer = document.getElementById('ar-container');
      const instructionsEl = document.getElementById('instructions');
      const infoPanelEl = document.getElementById('info-panel');
      const permissionRequestEl = document.getElementById('permission-request');
      const permissionDeniedEl = document.getElementById('permission-denied');
      const btnCapturar = document.getElementById('btn-capturar');
      
      // =============== UTILITY FUNCTIONS ===============
      
      function obtenerFechaHoy() {
        const hoy = new Date();
        const opciones = { 
          weekday: 'long', 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        };
        return hoy.toLocaleDateString('es-AR', opciones);
      }
      
      function mostrarToast(mensaje, tipo = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast ${tipo}`;
        toast.textContent = mensaje;
        document.body.appendChild(toast);
        
        setTimeout(() => {
          toast.style.opacity = '0';
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }
      
      // =============== SCREENSHOT FUNCTIONS ===============
      
      async function capturarScreenshot() {
        console.log('ğŸ“¸ Iniciando captura compuesta...');

        return new Promise((resolve) => {
          requestAnimationFrame(() => {
            requestAnimationFrame(async () => {
              try {
                // â”€â”€ 1. Encontrar el canvas WebGL de A-Frame â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                const scene = document.querySelector('a-scene');
                if (!scene) {
                  console.error('âŒ No se encontrÃ³ la escena A-Frame');
                  resolve(null);
                  return;
                }

                const glCanvas = scene.querySelector('canvas');
                if (!glCanvas) {
                  console.error('âŒ No se encontrÃ³ el canvas WebGL');
                  resolve(null);
                  return;
                }

                const w = glCanvas.width;
                const h = glCanvas.height;
                console.log('ğŸ“ Canvas WebGL:', w, 'x', h);

                // â”€â”€ 2. Encontrar el <video> del feed de cÃ¡mara â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                // MindAR crea un <video> dentro del ar-container o del scene
                const video = document.querySelector('#ar-container video')
                           || document.querySelector('a-scene video')
                           || document.querySelector('video');

                if (!video) {
                  console.warn('âš ï¸ No se encontrÃ³ el video de cÃ¡mara, capturando solo WebGL');
                  const dataUrl = glCanvas.toDataURL('image/jpeg', 0.85);
                  resolve(dataUrl && dataUrl.length > 1000 ? dataUrl : null);
                  return;
                }

                console.log('ğŸ“¹ Video encontrado:', video.videoWidth, 'x', video.videoHeight,
                            '| readyState:', video.readyState);

                // â”€â”€ 3. Crear canvas compuesto â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                const composite = document.createElement('canvas');
                composite.width  = w;
                composite.height = h;
                const ctx = composite.getContext('2d');

                if (!ctx) {
                  console.error('âŒ No se pudo obtener contexto 2D del canvas compuesto');
                  resolve(null);
                  return;
                }

                // â”€â”€ 4. Dibujar el video como fondo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                // El video puede tener distinta proporciÃ³n; lo estiramos para
                // cubrir exactamente el mismo viewport que el canvas WebGL
                try {
                  ctx.drawImage(video, 0, 0, w, h);
                  console.log('âœ… Video dibujado en canvas compuesto');
                } catch (videoErr) {
                  console.warn('âš ï¸ No se pudo dibujar el video:', videoErr.message);
                  // Continuar de todos modos â€” al menos se verÃ¡ el overlay 3D
                }

                // â”€â”€ 5. Dibujar el canvas WebGL encima â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                try {
                  ctx.drawImage(glCanvas, 0, 0, w, h);
                  console.log('âœ… Canvas WebGL superpuesto');
                } catch (glErr) {
                  console.error('âŒ No se pudo dibujar el canvas WebGL:', glErr.message);
                  resolve(null);
                  return;
                }

                // â”€â”€ 6. Exportar la imagen compuesta â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                const dataUrl = composite.toDataURL('image/jpeg', 0.85);
                const sizeKB  = Math.round(dataUrl.length / 1024);
                console.log('âœ… Screenshot compuesto OK:', sizeKB, 'KB');

                if (!dataUrl || dataUrl.length < 1000) {
                  console.error('âŒ Screenshot invÃ¡lido, tamaÃ±o:', dataUrl?.length);
                  resolve(null);
                  return;
                }

                resolve(dataUrl);

              } catch (error) {
                console.error('âŒ Error en captura compuesta:', error);
                resolve(null);
              }
            });
          });
        });
      }

      async function capturarYGuardar() {
        console.log('ğŸ“¸ Proceso de captura...');
        
        if (!currentBaldosa) {
          mostrarToast('Error: baldosa no detectada', 'error');
          return;
        }
        
        // ESPERAR 500ms para render completo
        console.log('â³ Esperando render...');
        await new Promise(resolve => setTimeout(resolve, 500));
        
        const foto = await capturarScreenshot();
        
        if (!foto) {
          mostrarToast('Error capturando foto', 'error');
          return;
        }
        
        if (foto.length < 1000) {
          console.error('âŒ Foto muy pequeÃ±a');
          mostrarToast('Error: foto invÃ¡lida', 'error');
          return;
        }
        
        console.log('âœ… Foto vÃ¡lida');
        
        // Verificar si el usuario estÃ¡ autenticado
        const isAuthenticated = await checkAuth();
        
        if (isAuthenticated) {
          // Guardar en backend
          console.log('ğŸ” Usuario autenticado, guardando en backend...');
          
          try {
            const response = await fetch('/api/recorridos', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                baldosaId: currentBaldosa.codigo || currentBaldosa.id,
                nombreVictima: currentBaldosa.nombre,
                fechaDesaparicion: currentBaldosa.fechaDesaparicion || '',
                fotoBase64: foto,
                ubicacion: currentBaldosa.direccion || currentBaldosa.barrio || 'Buenos Aires',
                lat: currentBaldosa.lat,
                lng: currentBaldosa.lng,
                notas: ''
              })
            });
            
            const data = await response.json();
            
            if (!response.ok) {
              if (data.error && data.error.includes('Ya has escaneado')) {
                mostrarToast('Ya tenÃ©s esta baldosa en tu recorrido', 'info');
              } else {
                throw new Error(data.error || 'Error al guardar');
              }
            } else {
              console.log('âœ… Guardado en backend');
              mostrarToast('Â¡Foto guardada! ğŸ“¸', 'success');
            }
            
            setTimeout(() => {
              window.location.href = '/coleccion';
            }, 1000);
            
          } catch (error) {
            console.error('âŒ Error guardando en backend:', error);
            mostrarToast('Error al guardar', 'error');
          }
          
        } else {
          // Usuario no autenticado - guardar en localStorage
          console.log('ğŸ“± Usuario no autenticado, guardando en localStorage...');
          
          const coleccionStr = localStorage.getItem('baldosas_coleccion');
          let coleccion = { items: [], totalEscaneos: 0 };
          
          if (coleccionStr) {
            try {
              coleccion = JSON.parse(coleccionStr);
            } catch (e) {
              console.error('Error parseando recorrido:', e);
            }
          }
          
          // Check duplicate
          const yaExiste = coleccion.items.some(item => 
            item.baldosaId === (currentBaldosa.codigo || currentBaldosa.id)
          );
          
          if (yaExiste) {
            mostrarToast('Ya tenÃ©s esta baldosa guardada', 'info');
            return;
          }
          
          // Create item
          const nuevoItem = {
            id: `item_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            baldosaId: currentBaldosa.codigo || currentBaldosa.id,
            nombreVictima: currentBaldosa.nombre,
            fechaDesaparicion: currentBaldosa.fechaDesaparicion || '',
            fechaEscaneo: new Date().toISOString(),
            fotoUrl: foto,
            ubicacion: currentBaldosa.direccion || currentBaldosa.barrio || 'Buenos Aires',
            lat: currentBaldosa.lat,
            lng: currentBaldosa.lng,
            notas: ''
          };
          
          console.log('ğŸ’¾ Guardando...');
          
          coleccion.items.unshift(nuevoItem);
          coleccion.totalEscaneos = coleccion.items.length;
          coleccion.ultimoEscaneo = nuevoItem.fechaEscaneo;
          
          try {
            localStorage.setItem('baldosas_coleccion', JSON.stringify(coleccion));
            console.log('âœ… Guardado en localStorage');
          } catch (e) {
            console.error('âŒ Error guardando:', e);
            if (e.name === 'QuotaExceededError') {
              mostrarToast('Almacenamiento lleno', 'error');
            } else {
              mostrarToast('Error al guardar', 'error');
            }
            return;
          }
          
          mostrarToast('Â¡Foto guardada! ğŸ“¸', 'success');
          mostrarToast('Inicia sesiÃ³n para guardar tu recorrido en la nube', 'info');
        }
      }
      
      // Verificar autenticaciÃ³n
      async function checkAuth() {
        try {
          const response = await fetch('/api/auth/me');
          return response.ok;
        } catch (error) {
          return false;
        }
      }
      
      // =============== PERMISSIONS ===============
      
      async function solicitarPermisos() {
        console.log('ğŸ“ Solicitando permisos...');
        
        try {
          // Location permission
          const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject);
          });
          
          userLocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          
          console.log('âœ… UbicaciÃ³n obtenida:', userLocation);
          
          // Camera permission (will be requested by A-Frame)
          permissionRequestEl.style.display = 'none';
          cargarBaldosa();
          
        } catch (error) {
          console.error('âŒ Error permisos:', error);
          permissionRequestEl.style.display = 'none';
          permissionDeniedEl.style.display = 'flex';
        }
      }
      
      // =============== LOAD BALDOSA ===============
      
      async function cargarBaldosa() {
        console.log('ğŸ”„ Cargando baldosa...');
        
        const params = new URLSearchParams(window.location.search);
        const baldosaId = params.get('id');
        
        loadingText.textContent = 'Cargando informaciÃ³n de la baldosa...';
        
        try {
          let baldosa;
          
          if (baldosaId) {
            // Cargar baldosa especÃ­fica
            console.log('ğŸ“‹ Cargando baldosa ID:', baldosaId);
            const response = await fetch(`/api/baldosas/${baldosaId}`);
            
            console.log('ğŸ“¡ Response status:', response.status);
            console.log('ğŸ“¡ Response ok:', response.ok);
            
            const data = await response.json();
            
            console.log('ğŸ“¦ Respuesta API completa:', data);
            console.log('ğŸ“¦ Tipo de data:', typeof data);
            console.log('ğŸ“¦ Keys de data:', Object.keys(data));
            
            if (!data.baldosa) {
              console.error('âŒ data.baldosa no existe!');
              console.error('âŒ data completo:', JSON.stringify(data, null, 2));
              throw new Error('Baldosa no encontrada');
            }
            
            console.log('ğŸ“¦ data.baldosa:', data.baldosa);
            console.log('ğŸ“¦ Keys de data.baldosa:', Object.keys(data.baldosa));
            
            baldosa = data.baldosa;
            
          } else {
            // Cargar baldosa mÃ¡s cercana o primera disponible
            console.log('ğŸ“ Cargando baldosa mÃ¡s cercana...');
            const response = await fetch('/api/baldosas');
            const data = await response.json();
            
            if (!data.baldosas || data.baldosas.length === 0) {
              throw new Error('No hay baldosas disponibles');
            }
            
            // Si hay ubicaciÃ³n, buscar la mÃ¡s cercana
            if (userLocation) {
              baldosa = data.baldosas.reduce((closest, current) => {
                const currentDist = calcularDistancia(
                  userLocation.lat, 
                  userLocation.lng,
                  current.lat,
                  current.lng
                );
                
                const closestDist = calcularDistancia(
                  userLocation.lat,
                  userLocation.lng,
                  closest.lat,
                  closest.lng
                );
                
                return currentDist < closestDist ? current : closest;
              });
              
              console.log('ğŸ“ Baldosa mÃ¡s cercana:', baldosa.nombre);
            } else {
              // Si no hay ubicaciÃ³n, usar la primera
              baldosa = data.baldosas[0];
              console.log('ğŸ“‹ Usando primera baldosa:', baldosa.nombre);
            }
          }
          
          console.log('âœ… Baldosa cargada:', baldosa.nombre);
          console.log('ğŸ” Campos de baldosa:', {
            fotoUrl: baldosa.fotoUrl,
            imagenUrl: baldosa.imagenUrl,
            mindFileUrl: baldosa.mindFileUrl
          });
          
          iniciarAR(baldosa);
          
        } catch (error) {
          console.error('âŒ Error cargando baldosa:', error);
          mostrarToast('Error cargando baldosa', 'error');
          setTimeout(() => window.location.href = '/', 2000);
        }
      }
      
      function calcularDistancia(lat1, lon1, lat2, lon2) {
        const R = 6371; // Radio de la Tierra en km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = 
          Math.sin(dLat/2) * Math.sin(dLat/2) +
          Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
          Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
      }
      
      // =============== LOAD AR SCRIPTS ===============
      
      async function cargarScriptsAR() {
        if (scriptsLoaded) return;
        
        console.log('ğŸ“¦ Cargando librerÃ­as AR...');
        loadingText.textContent = 'Cargando librerÃ­as AR...';
        
        return new Promise((resolve, reject) => {
          const aframe = document.createElement('script');
          aframe.src = 'https://cdn.jsdelivr.net/npm/aframe@1.6.0/dist/aframe-master.min.js';
          
          const mindar = document.createElement('script');
          mindar.src = 'https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js';
          
          aframe.onload = () => {
            console.log('âœ… A-Frame cargado');
            document.head.appendChild(mindar);
          };
          
          mindar.onload = () => {
            console.log('âœ… MindAR cargado');
            scriptsLoaded = true;
            resolve();
          };
          
          mindar.onerror = () => {
            console.error('âŒ Error cargando MindAR');
            reject(new Error('Error cargando MindAR'));
          };
          
          document.head.appendChild(aframe);
        });
      }
      
      // =============== INIT AR ===============
      
      async function iniciarAR(baldosa) {
        console.log('ğŸš€ INICIANDO AR');
        console.log('ğŸ“‹ Baldosa:', baldosa.nombre);
        console.log('ğŸ“¸ fotoUrl:', baldosa.fotoUrl);
        
        loadingText.textContent = 'Cargando experiencia AR...';
        loadingStatus.textContent = `Baldosa: ${baldosa.nombre}`;
        
        await cargarScriptsAR();
        
        const mindUrl = baldosa.mindFileUrl || `/targets/baldosa-${baldosa.id}.mind`;
        const glbUrl = `/models/portaretrato_generico.glb`;
        
        // Usar fotoUrl de la baldosa, con fallback a imagenUrl
        const fotoUrl = baldosa.fotoUrl || baldosa.imagenUrl || '/images/placeholder.jpg';
        
        console.log('ğŸ¯ Target:', mindUrl);
        console.log('ğŸ® Modelo:', glbUrl);
        console.log('ğŸ“¸ fotoUrl de baldosa:', baldosa.fotoUrl);
        console.log('ğŸ“¸ imagenUrl de baldosa:', baldosa.imagenUrl);
        console.log('ğŸ“¸ Foto final a usar:', fotoUrl);
        
        const fotoUrlFinal = fotoUrl;
        

        // ================================================================
        // SISTEMA DE COORDENADAS EN MINDAR (leer antes de tocar valores)
        // ================================================================
        //
        //   La imagen de la baldosa define el PLANO DEL TARGET.
        //   El origin (0, 0, 0) estÃ¡ en el CENTRO GEOMÃ‰TRICO de la imagen.
        //   1 unidad 3D = el ANCHO real de la imagen target.
        //
        //   Ejes locales del target:
        //
        //       Y â–²  (apunta hacia arriba a lo largo de la imagen)
        //         â”‚
        //         â”‚
        //         â””â”€â”€â”€â”€â–º X  (apunta hacia la derecha de la imagen)
        //        /
        //       â–¼ Z  (apunta hacia la CÃMARA, sale de la imagen)
        //
        //   PosiciÃ³n:
        //     x > 0  â†’ derecha de la baldosa
        //     x < 0  â†’ izquierda de la baldosa
        //     y > 0  â†’ ARRIBA de la baldosa  â† necesario para "salir por encima"
        //     y < 0  â†’ debajo de la baldosa
        //     z > 0  â†’ hacia la cÃ¡mara (flotando sobre la superficie)
        //     z < 0  â†’ detrÃ¡s de la baldosa (invisible)
        //
        //   RotaciÃ³n (en grados, eje X es el que mÃ¡s importa):
        //     rotation="0   0 0" â†’ cara del portaretrato mira directamente a la cÃ¡mara
        //                          (como una foto pegada verticalmente en la baldosa)
        //     rotation="-90 0 0" â†’ cara mira hacia ARRIBA
        //                          (portaretrato acostado en el suelo, boca arriba) â† INICIO
        //     rotation="-12 0 0" â†’ casi vertical, levemente inclinado hacia atrÃ¡s  â† FIN
        //
        //   La animaciÃ³n de "levantarse del piso" es:
        //     -90Â° en X  â†’  -12Â° en X  (recorrido de ~78Â°, un cuarto de vuelta)
        // ================================================================

        // ================================================================
        // âš™ï¸  TUNING â€” modificÃ¡ estos valores para ajustar la escena
        // ================================================================
        const TUNING = {

          // â”€â”€ Baldosa â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          // RelaciÃ³n de aspecto de la imagen de la baldosa (alto / ancho).
          // Una baldosa cuadrada = 1.0. Si es mÃ¡s alta que ancha, > 1.0.
          // Esto determina dÃ³nde estÃ¡ el borde superior de la imagen.
          // Borde superior = 0.5 * BALDOSA_ASPECT  (en unidades 3D)
          BALDOSA_ASPECT: 1.0,

          // Margen adicional sobre el borde superior de la baldosa (en unidades).
          // 0.0 = aparece justo en el borde. 0.15 = un poco mÃ¡s arriba.
          MARGEN_SOBRE_BALDOSA: 0.10,

          // â”€â”€ RotaciÃ³n inicial (portaretrato ACOSTADO) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          // -90Â° = cara mira arriba (boca arriba en el piso) â† recomendado
          //  90Â° = cara mira abajo (boca abajo)
          //   0Â° = cara mira a la cÃ¡mara (ya levantado, no tiene gracia)
          ROT_INICIO_X: -90,
          ROT_INICIO_Y:   0,
          ROT_INICIO_Z:   0,

          // â”€â”€ RotaciÃ³n final (posiciÃ³n de reposo levantado) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          // Valores negativos en X = inclina la parte superior HACIA la cÃ¡mara.
          // Valores positivos en X = inclina la parte superior LEJOS de la cÃ¡mara.
          // -12Â° X + leve Y/Z = look dramÃ¡tico, semi-apoyado hacia atrÃ¡s.
          ROT_FIN_X:  -12,
          ROT_FIN_Y:   -8,   // giro lateral: negativo = hacia la izquierda
          ROT_FIN_Z:    2,   // cabeceo: positivo = leve inclinaciÃ³n lateral derecha

          // â”€â”€ PosiciÃ³n inicial (aparece sobre el borde superior) â”€â”€â”€â”€â”€â”€â”€â”€â”€
          // Se calcula automÃ¡ticamente a partir de BALDOSA_ASPECT + MARGEN.
          // PodÃ©s pisar el Y inicial aquÃ­ si querÃ©s ajuste fino:
          //   POS_INICIO_Y: null â†’ usa el cÃ¡lculo automÃ¡tico
          //   POS_INICIO_Y: 0.7  â†’ fuerza ese valor
          POS_INICIO_Y: null,   // null = automÃ¡tico

          POS_INICIO_X: 0.0,    // centrado horizontalmente
          POS_INICIO_Z: 0.05,   // levemente sobre la superficie de la baldosa

          // â”€â”€ PosiciÃ³n final (portaretrato levantado, flotando) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          // Y positivo = flota mÃ¡s alto sobre la baldosa
          // Z positivo = mÃ¡s cerca de la cÃ¡mara
          POS_FIN_X: 0.0,
          POS_FIN_Y: 0.55,   // altura final sobre el centro de la baldosa
          POS_FIN_Z: 0.80,   // distancia hacia la cÃ¡mara al terminar

          // â”€â”€ Escala del portaretrato â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          // Escala uniforme del grupo entero (portaretrato + foto se escalan juntos).
          // 1.0 = tamaÃ±o original. 1.4 = 40% mÃ¡s grande.
          ESCALA: 1.4,

          // â”€â”€ AnimaciÃ³n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          // DuraciÃ³n en milisegundos. 2500â€“3500 suele sentirse natural.
          DURACION_MS: 2800,
          // Curva de easing. Opciones: easeOutCubic | easeOutQuart | easeOutBack | linear
          EASING: 'easeOutCubic',

          // â”€â”€ Foto dentro del portaretrato â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          // AjustÃ¡ si la foto no encaja bien en el marco del modelo 3D.
          // width / height en unidades locales (antes de aplicar ESCALA).
          FOTO_WIDTH:  0.77,
          FOTO_HEIGHT: 0.97,
          FOTO_Z:      0.022,  // separaciÃ³n de la superficie del marco (< 0.03)
        };

        // â”€â”€ CÃ¡lculo de posiciÃ³n inicial sobre la baldosa â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const topEdge    = 0.5 * TUNING.BALDOSA_ASPECT;   // borde superior en unidades 3D
        const posInicioY = TUNING.POS_INICIO_Y !== null
                           ? TUNING.POS_INICIO_Y
                           : topEdge + TUNING.MARGEN_SOBRE_BALDOSA;

        console.log(`ğŸ“ Borde superior baldosa: ${topEdge.toFixed(3)} u â†’ posiciÃ³n inicio Y: ${posInicioY.toFixed(3)} u`);

        // â”€â”€ Strings para A-Frame â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const posInicio = `${TUNING.POS_INICIO_X} ${posInicioY.toFixed(3)} ${TUNING.POS_INICIO_Z}`;
        const posFin    = `${TUNING.POS_FIN_X} ${TUNING.POS_FIN_Y} ${TUNING.POS_FIN_Z}`;
        const rotInicio = `${TUNING.ROT_INICIO_X} ${TUNING.ROT_INICIO_Y} ${TUNING.ROT_INICIO_Z}`;
        const rotFin    = `${TUNING.ROT_FIN_X} ${TUNING.ROT_FIN_Y} ${TUNING.ROT_FIN_Z}`;
        const escala    = `${TUNING.ESCALA} ${TUNING.ESCALA} ${TUNING.ESCALA}`;

        arContainer.innerHTML = `
          <a-scene
            mindar-image="imageTargetSrc: ${mindUrl}; maxTrack: 1; filterMinCF: 0.0001; filterBeta: 0.001;"
            color-space="sRGB"
            renderer="colorManagement: true, physicallyCorrectLights"
            vr-mode-ui="enabled: false"
            device-orientation-permission-ui="enabled: false"
            style="width: 100%; height: 100%;">

            <a-assets timeout="10000">
              <a-asset-item id="modelo-portaretrato" src="${glbUrl}"></a-asset-item>
              <img id="foto-ar" src="${fotoUrlFinal}" crossorigin="anonymous">
            </a-assets>

            <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

            <!-- â”€â”€ ILUMINACIÃ“N CÃLIDA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                 Tres fuentes para envolver el modelo con luz dorada de tarde.
                 AjustÃ¡ "intensity" para mÃ¡s/menos brillo.
                 AjustÃ¡ "color" en formato hex para cambiar temperatura. -->

            <!-- Base cÃ¡lida general (sin direcciÃ³n) -->
            <a-light type="ambient"     color="#FFD4A0" intensity="0.55"></a-light>

            <!-- Luz principal desde arriba-izquierda -->
            <a-light type="directional" color="#FFB347" intensity="1.4"
                     position="-1.5 2.5 1.5"></a-light>

            <!-- Contraluz tenue desde abajo-derecha para dar volumen -->
            <a-light type="point"       color="#FF9060" intensity="0.35"
                     position="1.2 -0.5 -0.8"></a-light>

            <!-- â”€â”€ OBJETO AR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->

            <a-entity mindar-image-target="targetIndex: 0">

              <!--
                GRUPO PRINCIPAL â€” contiene portaretrato + foto.
                Todos los valores vienen del objeto TUNING de arriba.

                position inicial = justo sobre el borde superior de la baldosa
                rotation inicial = acostado boca arriba en el piso (-90Â° en X)
                scale            = tamaÃ±o uniforme del conjunto

                Las dos animaciones arrancan simultÃ¡neamente cuando MindAR
                dispara el evento "targetFound".
              -->
              <a-entity
                id="portaretrato-grupo"
                position="${posInicio}"
                rotation="${rotInicio}"
                scale="${escala}"
                animation__pos="property: position;
                                to: ${posFin};
                                dur: ${TUNING.DURACION_MS};
                                easing: ${TUNING.EASING};
                                startEvents: targetFound"
                animation__rot="property: rotation;
                                to: ${rotFin};
                                dur: ${TUNING.DURACION_MS};
                                easing: ${TUNING.EASING};
                                startEvents: targetFound">

                <!-- Modelo 3D del portaretrato (no tocar escala aquÃ­,
                     se controla desde el grupo padre con TUNING.ESCALA) -->
                <a-entity
                  id="portaretrato"
                  gltf-model="#modelo-portaretrato"
                  position="0 0 0"
                  scale="1.0 1.0 1.0">
                </a-entity>

                <!-- Foto dentro del portaretrato.
                     TUNING.FOTO_WIDTH / FOTO_HEIGHT controlan que cubra el marco
                     sin dejar gap. TUNING.FOTO_Z controla separaciÃ³n del marco. -->
                <a-plane
                  id="foto-dinamica"
                  src="#foto-ar"
                  position="0 0 ${TUNING.FOTO_Z}"
                  rotation="0 0 0"
                  width="${TUNING.FOTO_WIDTH}"
                  height="${TUNING.FOTO_HEIGHT}"
                  material="shader: flat; side: double; transparent: false; alphaTest: 0.1"
                  visible="true">
                </a-plane>

              </a-entity>
            </a-entity>
          </a-scene>
        `;

        arContainer.style.display = 'block';
        
        const scene = arContainer.querySelector('a-scene');
        
        scene.addEventListener('loaded', () => {
          console.log('ğŸ¬ ESCENA AR CARGADA');
          
          // Check image loaded
          const fotoImg = document.getElementById('foto-ar');
          if (fotoImg) {
            console.log('ğŸ–¼ï¸ Elemento foto encontrado');
            console.log('   src configurado:', fotoImg.src);
            console.log('   src esperado:', fotoUrlFinal);
            
            fotoImg.onload = () => {
              console.log('âœ… Imagen cargada exitosamente!');
              console.log('   Dimensiones:', fotoImg.naturalWidth, 'x', fotoImg.naturalHeight);
            };
            fotoImg.onerror = (e) => {
              console.error('âŒ Error cargando imagen');
              console.error('   URL que fallÃ³:', fotoUrlFinal);
              console.error('   Error:', e);
            };
          } else {
            console.error('âŒ No se encontrÃ³ elemento foto-ar');
          }
          
          loadingEl.style.display = 'none';
          document.getElementById('btn-mapa').style.display = 'flex';
          document.getElementById('instruction-baldosa-name').textContent = baldosa.nombre;
          document.getElementById('instruction-baldosa-address').textContent = baldosa.direccion || '';
          instructionsEl.style.display = 'block';
          
          setTimeout(() => {
            instructionsEl.style.opacity = '0';
            setTimeout(() => instructionsEl.style.display = 'none', 500);
          }, 3000);
          
          mostrarToast('CÃ¡mara lista. EnfocÃ¡ la baldosa.');
        });
        
        setTimeout(() => {
          const target = arContainer.querySelector('[mindar-image-target]');
          
          if (target) {
            target.addEventListener('targetFound', () => {
              console.log('ğŸ¯ Â¡BALDOSA DETECTADA!');
              
              currentBaldosa = baldosa;
              instructionsEl.style.display = 'none';
              btnCapturar.style.display = 'flex';
              
              // Disparar evento para reiniciar animaciÃ³n
              const grupo = document.getElementById('portaretrato-grupo');
              if (grupo) {
                console.log('ğŸ¬ Activando animaciÃ³n de levantamiento');
                grupo.emit('targetFound');
              }
              
              document.getElementById('info-nombre').textContent = baldosa.nombre;
              
              const ubicacionTexto = baldosa.barrio 
                ? `${baldosa.barrio}, Buenos Aires` 
                : baldosa.direccion || 'Buenos Aires';
              document.getElementById('info-ubicacion').textContent = ubicacionTexto;
              document.getElementById('info-fecha').textContent = obtenerFechaHoy();
              
              infoPanelEl.style.display = 'block';
            });
            
            target.addEventListener('targetLost', () => {
              console.log('ğŸ‘‹ BALDOSA PERDIDA');
              btnCapturar.style.display = 'none';
              infoPanelEl.style.display = 'none';
              
              // Resetear posiciÃ³n para prÃ³xima detecciÃ³n
              const grupo = document.getElementById('portaretrato-grupo');
              if (grupo) {
                grupo.setAttribute('position', posInicio);   // calculado dinÃ¡micamente
                grupo.setAttribute('rotation', rotInicio);   // = "-90 0 0" por defecto
              }
            });
          }
        }, 1000);
      }
      
      // =============== INIT APP ===============
      
      window.addEventListener('DOMContentLoaded', () => {
        console.log('ğŸš€ App iniciada');
        permissionRequestEl.style.display = 'flex';
      });
    </script>
  </body>
</html>