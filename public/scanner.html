<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="UTF-8">
    <title>Escanear Baldosa - Baldosas por la Memoria</title>
    
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        overflow: hidden;
        background: #1a2a3a;
      }
      
      #loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #1a2a3a;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        color: white;
      }
      
      #loading .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255,255,255,0.2);
        border-top-color: #2563eb;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      
      #loading p {
        font-size: 16px;
        opacity: 0.9;
        text-align: center;
        padding: 0 20px;
      }
      
      #loading .hint {
        font-size: 13px;
        opacity: 0.6;
        margin-top: 10px;
      }
      
      #loading .status {
        margin-top: 20px;
        padding: 10px 20px;
        background: rgba(255,255,255,0.1);
        border-radius: 8px;
        font-size: 14px;
      }
      
      #permission-request {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #1a2a3a;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        color: white;
        padding: 30px;
        text-align: center;
      }
      
      #permission-request .icon {
        font-size: 72px;
        margin-bottom: 25px;
        animation: pulse 2s ease-in-out infinite;
      }
      
      @keyframes pulse {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.8; }
      }
      
      #permission-request h2 {
        font-size: 1.6rem;
        margin-bottom: 15px;
        font-weight: 600;
      }
      
      #permission-request p {
        opacity: 0.85;
        margin-bottom: 15px;
        max-width: 400px;
        line-height: 1.5;
      }
      
      #permission-request .why {
        font-size: 0.9rem;
        opacity: 0.7;
        margin-bottom: 30px;
        max-width: 350px;
      }
      
      #permission-request button {
        padding: 15px 40px;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 15px;
      }
      
      #permission-request button:hover {
        background: #1d4ed8;
        transform: scale(1.02);
      }
      
      #permission-request .skip-btn {
        background: transparent;
        border: 2px solid rgba(255,255,255,0.3);
        font-size: 14px;
        padding: 10px 25px;
      }
      
      #permission-request .skip-btn:hover {
        border-color: rgba(255,255,255,0.5);
        background: rgba(255,255,255,0.1);
      }
      
      #permission-denied {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #1a2a3a;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        color: white;
        padding: 30px;
        text-align: center;
      }
      
      #permission-denied .icon {
        font-size: 64px;
        margin-bottom: 20px;
      }
      
      #permission-denied h2 {
        font-size: 1.5rem;
        margin-bottom: 15px;
        color: #ef4444;
      }
      
      #permission-denied p {
        opacity: 0.85;
        margin-bottom: 10px;
        max-width: 400px;
        line-height: 1.5;
      }
      
      #permission-denied .instructions {
        background: rgba(255,255,255,0.1);
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
        text-align: left;
        max-width: 350px;
      }
      
      #permission-denied .instructions h3 {
        font-size: 1rem;
        margin-bottom: 10px;
        color: #0ea5e9;
      }
      
      #permission-denied .instructions ol {
        margin-left: 20px;
        font-size: 0.9rem;
        opacity: 0.9;
      }
      
      #permission-denied .instructions li {
        margin-bottom: 8px;
      }
      
      #permission-denied button {
        padding: 12px 30px;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        margin-top: 20px;
      }
      
      #no-baldosa {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #1a2a3a;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9998;
        color: white;
        padding: 30px;
        text-align: center;
      }
      
      #no-baldosa .icon {
        font-size: 64px;
        margin-bottom: 20px;
      }
      
      #no-baldosa h2 {
        font-size: 1.5rem;
        margin-bottom: 15px;
      }
      
      #no-baldosa p {
        opacity: 0.8;
        margin-bottom: 10px;
        max-width: 400px;
      }
      
      #no-baldosa .distance {
        font-size: 2rem;
        font-weight: bold;
        color: #2563eb;
        margin: 20px 0;
      }
      
      #no-baldosa .baldosa-name {
        font-size: 1.1rem;
        color: #0ea5e9;
        margin-bottom: 20px;
      }
      
      #no-baldosa button {
        padding: 12px 30px;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        margin-top: 20px;
      }
      
      #no-baldosa .btn-secondary {
        background: transparent;
        border: 2px solid rgba(255,255,255,0.3);
        margin-left: 10px;
      }
      
      #instructions {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(26, 42, 58, 0.95);
        color: white;
        padding: 30px;
        border-radius: 16px;
        text-align: center;
        z-index: 1000;
        max-width: 90%;
        width: 380px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.1);
        box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        transition: opacity 0.5s ease-out;
        display: none;
      }
      
      #instructions .icon {
        font-size: 48px;
        margin-bottom: 15px;
      }
      
      #instructions h2 {
        font-size: 1.4rem;
        margin-bottom: 10px;
        font-weight: 600;
      }
      
      #instructions p {
        font-size: 0.95rem;
        opacity: 0.85;
        line-height: 1.5;
        margin-bottom: 15px;
      }
      
      #instructions .baldosa-info {
        background: rgba(37, 99, 235, 0.2);
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
      }
      
      #instructions .baldosa-info .name {
        font-weight: 600;
        font-size: 1.1rem;
        color: #0ea5e9;
      }
      
      #instructions .baldosa-info .address {
        font-size: 0.85rem;
        opacity: 0.7;
        margin-top: 5px;
      }
      
      #info-panel {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        color: white;
        padding: 0;
        z-index: 1000;
        display: none;
        animation: slideUp 0.3s ease-out;
        overflow: hidden;
      }
      
      #info-panel .baldosa-bg {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: url('/baldoson.jpg');
        background-size: cover;
        background-position: center;
        filter: brightness(0.3);
        z-index: 0;
      }
      
      #info-panel .content {
        position: relative;
        z-index: 1;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-width: 600px;
        margin: 0 auto;
      }
      
      #info-panel .top-row {
        display: flex;
        align-items: flex-start;
        gap: 15px;
      }
      
      #info-panel .checkmark {
        width: 50px;
        height: 50px;
        background: #2563eb;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        flex-shrink: 0;
      }
      
      #info-panel .info-text {
        flex: 1;
      }
      
      #info-panel h3 {
        font-size: 1.3rem;
        margin-bottom: 5px;
        text-shadow: 0 2px 4px rgba(0,0,0,0.5);
      }
      
      #info-panel .categoria {
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: #0ea5e9;
        margin-bottom: 5px;
      }
      
      /* Bot√≥n capturar */
      #btn-capturar {
        display: none;
        background: #10b981;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 25px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin: 0 auto;
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        transition: all 0.3s;
      }
      
      #btn-capturar:hover {
        background: #059669;
        transform: scale(1.05);
      }
      
      #btn-capturar:active {
        transform: scale(0.95);
      }
      
      @keyframes slideUp {
        from {
          transform: translateY(100%);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      
      #btn-volver {
        position: fixed;
        top: 15px;
        left: 15px;
        background: rgba(26, 42, 58, 0.9);
        color: white;
        padding: 10px 18px;
        border-radius: 8px;
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        z-index: 1001;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.1);
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background 0.2s;
      }
      
      #btn-volver:hover {
        background: rgba(26, 42, 58, 1);
      }
      
      #btn-mapa {
        position: fixed;
        top: 15px;
        right: 15px;
        background: rgba(37, 99, 235, 0.9);
        color: white;
        padding: 10px 18px;
        border-radius: 8px;
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        z-index: 1001;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.1);
        display: none;
        align-items: center;
        gap: 8px;
        transition: background 0.2s;
      }
      
      #btn-mapa:hover {
        background: rgba(37, 99, 235, 1);
      }
      
      .toast {
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: #2563eb;
        color: white;
        padding: 12px 24px;
        border-radius: 25px;
        font-size: 14px;
        z-index: 9999;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        animation: fadeInUp 0.3s ease-out;
      }
      
      .toast.success {
        background: #10b981;
      }
      
      .toast.error {
        background: #dc2626;
      }
      
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateX(-50%) translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateX(-50%) translateY(0);
        }
      }
      
      #ar-container {
        display: none;
        width: 100%;
        height: 100%;
      }
    </style>
  </head>

  <body>
    <div id="permission-request">
      <div class="icon">üìç</div>
      <h2>Necesitamos tu ubicaci√≥n</h2>
      <p>Para encontrar las baldosas de la memoria cercanas, necesitamos acceder a tu ubicaci√≥n.</p>
      <p class="why">Tu ubicaci√≥n solo se usa para mostrar baldosas cercanas y no se guarda ni comparte.</p>
      <button onclick="solicitarPermiso()">Permitir ubicaci√≥n</button>
      <button class="skip-btn" onclick="window.location.href='/mapa'">Ver mapa sin ubicaci√≥n</button>
    </div>
    
    <div id="permission-denied">
      <div class="icon">üö´</div>
      <h2>Ubicaci√≥n no disponible</h2>
      <p>No pudimos acceder a tu ubicaci√≥n. Para usar el esc√°ner, necesit√°s habilitar el permiso de ubicaci√≥n.</p>
      <div class="instructions">
        <h3>¬øC√≥mo habilitarlo?</h3>
        <ol>
          <li>Toc√° el √≠cono de candado üîí en la barra de direcciones</li>
          <li>Busc√° "Ubicaci√≥n" o "Location"</li>
          <li>Cambi√° a "Permitir"</li>
          <li>Recarg√° la p√°gina</li>
        </ol>
      </div>
      <button onclick="window.location.reload()">üîÑ Reintentar</button>
      <br>
      <a href="/mapa" style="display: inline-block; margin-top: 15px; color: #0ea5e9; text-decoration: none;">Ver mapa sin ubicaci√≥n ‚Üí</a>
    </div>
    
    <div id="loading" style="display: none;">
      <div class="spinner"></div>
      <p id="loading-text">Obteniendo tu ubicaci√≥n...</p>
      <p class="hint">Esto puede tardar unos segundos</p>
      <div class="status" id="loading-status"></div>
    </div>
    
    <div id="no-baldosa">
      <div class="icon">üìç</div>
      <h2>No hay baldosas cerca</h2>
      <p>Para escanear una baldosa, necesit√°s estar f√≠sicamente cerca de ella.</p>
      <div id="nearest-info" style="display: none;">
        <p>La baldosa m√°s cercana est√° a:</p>
        <div class="distance" id="nearest-distance">--</div>
        <div class="baldosa-name" id="nearest-name">--</div>
      </div>
      <div>
        <button onclick="reintentar()">üîÑ Actualizar ubicaci√≥n</button>
        <a href="/mapa" class="btn-secondary" style="display: inline-block; padding: 12px 30px; color: white; text-decoration: none; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; margin-left: 10px;">Ver mapa</a>
      </div>
    </div>
    
    <a href="/" id="btn-volver">
      ‚Üê Volver
    </a>
    
    <a href="/mapa" id="btn-mapa">
      üó∫Ô∏è Ver mapa
    </a>
    
    <div id="instructions">
      <div class="icon">üì∑</div>
      <h2>Apunt√° tu c√°mara a la baldosa</h2>
      <p>Est√°s cerca de una baldosa de la memoria. Enfocala con tu c√°mara para ver su historia.</p>
      <div class="baldosa-info">
        <div class="name" id="instruction-baldosa-name">--</div>
        <div class="address" id="instruction-baldosa-address">--</div>
      </div>
    </div>
    
    <div id="info-panel">
      <div class="baldosa-bg"></div>
      <div class="content">
        <div class="top-row">
          <div class="checkmark">‚úì</div>
          <div class="info-text">
            <h3 id="info-nombre">Nombre</h3>
            <div class="categoria" id="info-categoria">Categor√≠a</div>
          </div>
        </div>
        <button id="btn-capturar" onclick="capturarYGuardar()">
          üì∏ Capturar foto
        </button>
      </div>
    </div>

    <div id="ar-container"></div>

    <script>
      // =============== CONFIG ===============
      const RADIO_MAXIMO = 1000; // metros
      
      let baldosaCercana = null;
      let currentBaldosa = null;
      let userLocation = null;
      let scriptsLoaded = false;
      
      const loadingEl = document.getElementById('loading');
      const loadingText = document.getElementById('loading-text');
      const loadingStatus = document.getElementById('loading-status');
      const noBaldosaEl = document.getElementById('no-baldosa');
      const instructionsEl = document.getElementById('instructions');
      const infoPanelEl = document.getElementById('info-panel');
      const arContainer = document.getElementById('ar-container');
      const btnCapturar = document.getElementById('btn-capturar');
      
      // =============== UTILS ===============
      
      function calcularDistancia(lat1, lng1, lat2, lng2) {
        const R = 6371e3;
        const œÜ1 = (lat1 * Math.PI) / 180;
        const œÜ2 = (lat2 * Math.PI) / 180;
        const ŒîœÜ = ((lat2 - lat1) * Math.PI) / 180;
        const ŒîŒª = ((lng2 - lng1) * Math.PI) / 180;
        const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
                  Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }

      function mostrarToast(mensaje, tipo = 'info', duracion = 3000) {
        const toast = document.createElement('div');
        toast.className = 'toast' + (tipo === 'error' ? ' error' : tipo === 'success' ? ' success' : '');
        toast.textContent = mensaje;
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.style.opacity = '0';
          toast.style.transition = 'opacity 0.3s';
          setTimeout(() => toast.remove(), 300);
        }, duracion);
      }
      
      function obtenerFechaHoy() {
        const fecha = new Date();
        return fecha.toLocaleDateString('es-AR', {
          day: 'numeric',
          month: 'long',
          year: 'numeric'
        });
      }

      // =============== LOCATION ===============

      async function obtenerUbicacion() {
        return new Promise((resolve, reject) => {
          if (!navigator.geolocation) {
            reject(new Error('Geolocalizaci√≥n no disponible'));
            return;
          }
          
          navigator.geolocation.getCurrentPosition(
            (position) => {
              resolve({
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                accuracy: position.coords.accuracy
              });
            },
            (error) => {
              let msg = 'Error obteniendo ubicaci√≥n';
              if (error.code === error.PERMISSION_DENIED) msg = 'Permiso de ubicaci√≥n denegado';
              if (error.code === error.POSITION_UNAVAILABLE) msg = 'Ubicaci√≥n no disponible';
              if (error.code === error.TIMEOUT) msg = 'Tiempo de espera agotado';
              reject(new Error(msg));
            },
            { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
          );
        });
      }

      async function buscarBaldosasCercanas(lat, lng) {
        const response = await fetch(`/api/baldosas`);
        const data = await response.json();
        return data.baldosas || [];
      }

      // =============== AUTH ===============
      
      async function checkAuth() {
        try {
          const response = await fetch('/api/auth/me', {
            credentials: 'include'
          });
          return response.ok;
        } catch (error) {
          return false;
        }
      }

      // =============== CAPTURA ===============
      
      async function capturarScreenshot() {
        console.log('üì∏ Capturando AR completo (video + canvas)...');
        
        return new Promise((resolve) => {
          requestAnimationFrame(() => {
            requestAnimationFrame(() => {
              try {
                const video = document.querySelector('video');
                const scene = document.querySelector('a-scene');
                
                if (!video || !scene) {
                  console.error('‚ùå Video o escena no encontrados');
                  resolve(null);
                  return;
                }
                
                // Canvas temporal
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = video.videoWidth || 1280;
                tempCanvas.height = video.videoHeight || 720;
                
                console.log('üìê Canvas:', tempCanvas.width, 'x', tempCanvas.height);
                
                const ctx = tempCanvas.getContext('2d');
                
                // 1. Dibujar video (fondo)
                ctx.drawImage(video, 0, 0, tempCanvas.width, tempCanvas.height);
                console.log('‚úÖ Video dibujado');
                
                // 2. Dibujar AR encima
                const renderer = scene.renderer;
                if (renderer && renderer.domElement) {
                  const glCanvas = renderer.domElement;
                  ctx.drawImage(glCanvas, 0, 0, tempCanvas.width, tempCanvas.height);
                  console.log('‚úÖ AR dibujado encima');
                } else {
                  console.warn('‚ö†Ô∏è Renderer no disponible');
                }
                
                // Convertir a data URL
                const dataUrl = tempCanvas.toDataURL('image/jpeg', 0.92);
                
                if (!dataUrl || dataUrl.length < 1000) {
                  console.error('‚ùå Captura inv√°lida');
                  resolve(null);
                  return;
                }
                
                const sizeKB = Math.round(dataUrl.length / 1024);
                console.log('‚úÖ Screenshot capturado:', sizeKB, 'KB');
                
                resolve(dataUrl);
                
              } catch (error) {
                console.error('‚ùå Error capturando:', error);
                resolve(null);
              }
            });
          });
        });
      }
      
      async function capturarYGuardar() {
        console.log('üì∏ Proceso de captura...');
        
        if (!currentBaldosa) {
          mostrarToast('Error: baldosa no detectada', 'error');
          return;
        }
        
        // Esperar para render completo
        console.log('‚è≥ Esperando render...');
        await new Promise(resolve => setTimeout(resolve, 500));
        
        const foto = await capturarScreenshot();
        
        if (!foto) {
          mostrarToast('Error capturando foto', 'error');
          return;
        }
        
        if (foto.length < 1000) {
          console.error('‚ùå Foto muy peque√±a');
          mostrarToast('Error: foto inv√°lida', 'error');
          return;
        }
        
        console.log('‚úÖ Foto v√°lida');
        
        // Verificar si est√° autenticado
        const isAuthenticated = await checkAuth();
        
        if (isAuthenticated) {
          // Guardar en backend
          console.log('üîê Usuario autenticado, guardando en backend...');
          
          try {
            const response = await fetch('/api/recorridos', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                baldosaId: currentBaldosa.codigo || currentBaldosa.id,
                nombreVictima: currentBaldosa.nombre,
                fechaDesaparicion: currentBaldosa.fechaDesaparicion || '',
                fotoBase64: foto,
                ubicacion: currentBaldosa.direccion || currentBaldosa.barrio || 'Buenos Aires',
                lat: currentBaldosa.lat,
                lng: currentBaldosa.lng,
                notas: ''
              })
            });
            
            const data = await response.json();
            
            if (!response.ok) {
              if (data.error && data.error.includes('Ya has escaneado')) {
                mostrarToast('Ya ten√©s esta baldosa en tu recorrido', 'info');
              } else {
                throw new Error(data.error || 'Error al guardar');
              }
            } else {
              console.log('‚úÖ Guardado en backend');
              mostrarToast('¬°Foto guardada! üì∏', 'success');
            }
            
            setTimeout(() => {
              window.location.href = '/coleccion';
            }, 1000);
            
          } catch (error) {
            console.error('‚ùå Error guardando en backend:', error);
            mostrarToast('Error al guardar', 'error');
          }
          
        } else {
          // Usuario no autenticado - guardar en localStorage
          console.log('üì± Usuario no autenticado, guardando en localStorage...');
          
          const coleccionStr = localStorage.getItem('baldosas_coleccion');
          let coleccion = { items: [], totalEscaneos: 0 };
          
          if (coleccionStr) {
            try {
              coleccion = JSON.parse(coleccionStr);
            } catch (e) {
              console.error('Error parseando recorrido:', e);
            }
          }
          
          // Check duplicate
          const yaExiste = coleccion.items.some(item => 
            item.baldosaId === (currentBaldosa.codigo || currentBaldosa.id)
          );
          
          if (yaExiste) {
            mostrarToast('Ya ten√©s esta baldosa guardada', 'info');
            setTimeout(() => window.location.href = '/coleccion', 1000);
            return;
          }
          
          coleccion.items.push({
            baldosaId: currentBaldosa.codigo || currentBaldosa.id,
            nombreVictima: currentBaldosa.nombre,
            fechaDesaparicion: currentBaldosa.fechaDesaparicion || '',
            fechaEscaneo: new Date().toISOString(),
            fotoBase64: foto,
            ubicacion: currentBaldosa.direccion || currentBaldosa.barrio || 'Buenos Aires',
            lat: currentBaldosa.lat,
            lng: currentBaldosa.lng,
            notas: ''
          });
          
          coleccion.totalEscaneos = coleccion.items.length;
          
          localStorage.setItem('baldosas_coleccion', JSON.stringify(coleccion));
          
          console.log('‚úÖ Guardado en localStorage');
          mostrarToast('¬°Foto guardada! üì∏', 'success');
          
          setTimeout(() => {
            window.location.href = '/coleccion';
          }, 1000);
        }
      }

      // =============== LOAD AR SCRIPTS ===============
      
      async function cargarScriptsAR() {
        if (scriptsLoaded) return;
        
        console.log('üì¶ Cargando librer√≠as AR...');
        loadingText.textContent = 'Cargando librer√≠as AR...';
        
        return new Promise((resolve, reject) => {
          const aframe = document.createElement('script');
          aframe.src = 'https://cdn.jsdelivr.net/npm/aframe@1.6.0/dist/aframe-master.min.js';
          
          const mindar = document.createElement('script');
          mindar.src = 'https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js';
          
          aframe.onload = () => {
            console.log('‚úÖ A-Frame cargado');
            document.head.appendChild(mindar);
          };
          
          mindar.onload = () => {
            console.log('‚úÖ MindAR cargado');
            scriptsLoaded = true;
            resolve();
          };
          
          mindar.onerror = () => {
            console.error('‚ùå Error cargando MindAR');
            reject(new Error('Error cargando MindAR'));
          };
          
          document.head.appendChild(aframe);
        });
      }
      
      // =============== INIT AR ===============
      
      async function iniciarAR(baldosa) {
        console.log('üöÄ INICIANDO AR');
        console.log('üìã Baldosa:', baldosa.nombre);
        
        loadingText.textContent = 'Cargando experiencia AR...';
        loadingStatus.textContent = `Baldosa: ${baldosa.nombre}`;
        
        await cargarScriptsAR();
        
        const mindUrl = baldosa.mindFileUrl || `/targets/baldosa-${baldosa.id}.mind`;
        
        // Foto a mostrar
        const fotoUrl = baldosa.imagenUrl || baldosa.fotoUrl || '/images/placeholder.jpg';
        
        console.log('üéØ Target:', mindUrl);
        console.log('üì∏ Foto:', fotoUrl);
        
        arContainer.innerHTML = `
          <a-scene
            mindar-image="imageTargetSrc: ${mindUrl}; maxTrack: 1; filterMinCF: 0.0001; filterBeta: 0.001;"
            color-space="sRGB"
            renderer="colorManagement: true; physicallyCorrectLights: true; preserveDrawingBuffer: true;"
            vr-mode-ui="enabled: false"
            device-orientation-permission-ui="enabled: false"
            style="width: 100%; height: 100%;">
            
            <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
            
            <a-entity mindar-image-target="targetIndex: 0">
              
              <!-- Grupo contenedor con animaci√≥n -->
              <a-entity 
                id="portaretrato-grupo" 
                position="0 0 0.02" 
                rotation="90 0 0"
                scale="1.5 1.5 1.5"
                animation__pos="property: position; to: 0 0.5 1.0; dur: 3000; easing: easeOutQuad; startEvents: targetFound"
                animation__rot="property: rotation; to: 0 -10 0; dur: 3000; easing: easeOutQuad; startEvents: targetFound">
                
                <!-- Plano con la foto -->
                <a-plane
                  id="foto-dinamica"
                  src="${fotoUrl}"
                  position="0 0 0"
                  rotation="0 0 0"
                  width="0.6"
                  height="0.8"
                  material="shader: flat; side: double"
                  visible="true">
                </a-plane>
                
                <!-- Marco dorado (4 barras) -->
                <a-box position="0 0.425 -0.01" width="0.65" height="0.05" depth="0.02" color="#D4AF37"></a-box>
                <a-box position="0 -0.425 -0.01" width="0.65" height="0.05" depth="0.02" color="#D4AF37"></a-box>
                <a-box position="0.325 0 -0.01" width="0.05" height="0.9" depth="0.02" color="#D4AF37"></a-box>
                <a-box position="-0.325 0 -0.01" width="0.05" height="0.9" depth="0.02" color="#D4AF37"></a-box>
                
              </a-entity>
            </a-entity>
          </a-scene>
        `;
        
        arContainer.style.display = 'block';
        
        const scene = arContainer.querySelector('a-scene');
        
        scene.addEventListener('loaded', () => {
          console.log('üé¨ ESCENA AR CARGADA');
          
          loadingEl.style.display = 'none';
          document.getElementById('btn-mapa').style.display = 'flex';
          document.getElementById('instruction-baldosa-name').textContent = baldosa.nombre;
          document.getElementById('instruction-baldosa-address').textContent = baldosa.direccion || '';
          instructionsEl.style.display = 'block';
          
          setTimeout(() => {
            instructionsEl.style.opacity = '0';
            setTimeout(() => instructionsEl.style.display = 'none', 500);
          }, 3000);
          
          mostrarToast('C√°mara lista. Enfoc√° la baldosa.');
        });
        
        setTimeout(() => {
          const target = arContainer.querySelector('[mindar-image-target]');
          
          if (target) {
            target.addEventListener('targetFound', () => {
              console.log('üéØ ¬°BALDOSA DETECTADA!');
              
              currentBaldosa = baldosa;
              instructionsEl.style.display = 'none';
              btnCapturar.style.display = 'flex';
              
              // Activar animaci√≥n
              const grupo = document.getElementById('portaretrato-grupo');
              if (grupo) {
                console.log('üé¨ Activando animaci√≥n');
                grupo.emit('targetFound');
              }
              
              document.getElementById('info-nombre').textContent = baldosa.nombre;
              document.getElementById('info-categoria').textContent = baldosa.categoria || 'Hist√≥rico';
              infoPanelEl.style.display = 'block';
            });
            
            target.addEventListener('targetLost', () => {
              console.log('üëã BALDOSA PERDIDA');
              btnCapturar.style.display = 'none';
              infoPanelEl.style.display = 'none';
              
              // Resetear
              const grupo = document.getElementById('portaretrato-grupo');
              if (grupo) {
                grupo.setAttribute('position', '0 0 0.02');
                grupo.setAttribute('rotation', '90 0 0');
              }
            });
          }
        }, 1000);
      }

      // =============== NO BALDOSA ===============

      function mostrarNoBaldosa(baldosas, userLat, userLng) {
        loadingEl.style.display = 'none';
        noBaldosaEl.style.display = 'flex';
        
        if (baldosas.length > 0) {
          let cercana = baldosas[0];
          let distanciaMinima = calcularDistancia(userLat, userLng, cercana.lat, cercana.lng);
          
          baldosas.forEach(b => {
            const d = calcularDistancia(userLat, userLng, b.lat, b.lng);
            if (d < distanciaMinima) {
              distanciaMinima = d;
              cercana = b;
            }
          });
          
          document.getElementById('nearest-info').style.display = 'block';
          document.getElementById('nearest-distance').textContent = 
            distanciaMinima < 1000 ? `${Math.round(distanciaMinima)} metros` : `${(distanciaMinima/1000).toFixed(1)} km`;
          document.getElementById('nearest-name').textContent = cercana.nombre;
        }
      }

      async function reintentar() {
        noBaldosaEl.style.display = 'none';
        loadingEl.style.display = 'flex';
        loadingText.textContent = 'Actualizando ubicaci√≥n...';
        loadingStatus.textContent = '';
        await iniciar();
      }

      // =============== PERMISSIONS ===============

      const permissionRequestEl = document.getElementById('permission-request');
      const permissionDeniedEl = document.getElementById('permission-denied');

      async function verificarPermisoUbicacion() {
        if (navigator.permissions && navigator.permissions.query) {
          try {
            const result = await navigator.permissions.query({ name: 'geolocation' });
            return result.state;
          } catch (e) {
            return 'prompt';
          }
        }
        return 'prompt';
      }

      async function solicitarPermiso() {
        permissionRequestEl.style.display = 'none';
        loadingEl.style.display = 'flex';
        
        try {
          userLocation = await obtenerUbicacion();
          console.log('üìç Ubicaci√≥n obtenida:', userLocation);
          await continuarConUbicacion();
        } catch (error) {
          console.error('Error obteniendo ubicaci√≥n:', error);
          loadingEl.style.display = 'none';
          permissionDeniedEl.style.display = 'flex';
        }
      }

      async function continuarConUbicacion() {
        try {
          loadingStatus.textContent = `Precisi√≥n: ¬±${Math.round(userLocation.accuracy)}m`;
          
          loadingText.textContent = 'Buscando baldosas cercanas...';
          
          const baldosas = await buscarBaldosasCercanas(userLocation.lat, userLocation.lng);
          console.log('üó∫Ô∏è Baldosas encontradas:', baldosas.length);
          
          baldosaCercana = null;
          let distanciaMinima = Infinity;
          
          baldosas.forEach(b => {
            const distancia = calcularDistancia(userLocation.lat, userLocation.lng, b.lat, b.lng);
            console.log(`  - ${b.nombre}: ${Math.round(distancia)}m`);
            if (distancia < distanciaMinima) {
              distanciaMinima = distancia;
              if (distancia <= RADIO_MAXIMO) {
                baldosaCercana = { ...b, distancia };
              }
            }
          });
          
          if (baldosaCercana) {
            console.log('‚úÖ Baldosa cercana encontrada:', baldosaCercana.nombre);
            await iniciarAR(baldosaCercana);
          } else {
            console.log('‚ùå No hay baldosas dentro del radio');
            mostrarNoBaldosa(baldosas, userLocation.lat, userLocation.lng);
          }
          
        } catch (error) {
          console.error('Error:', error);
          loadingText.textContent = 'Error';
          loadingStatus.textContent = error.message;
          mostrarToast(error.message, 'error', 5000);
        }
      }

      // =============== INIT APP ===============

      async function iniciar() {
        const estadoPermiso = await verificarPermisoUbicacion();
        console.log('üîê Estado del permiso:', estadoPermiso);
        
        if (estadoPermiso === 'granted') {
          loadingEl.style.display = 'flex';
          try {
            userLocation = await obtenerUbicacion();
            await continuarConUbicacion();
          } catch (error) {
            loadingEl.style.display = 'none';
            permissionDeniedEl.style.display = 'flex';
          }
        } else if (estadoPermiso === 'denied') {
          permissionDeniedEl.style.display = 'flex';
        } else {
          permissionRequestEl.style.display = 'flex';
        }
      }

      iniciar();
    </script>
  </body>
</html>
